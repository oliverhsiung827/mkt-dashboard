<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>ä¸Šæ´‹è¡ŒéŠ·æˆ°æƒ…å®¤ | UP YOUNG Marketing System</title>
    <meta name="description" content="ä¸Šæ´‹ç”¢æ¥­è¡ŒéŠ·éƒ¨å°ˆæ¡ˆç®¡ç†ç³»çµ±ã€‚æ•´åˆå„€è¡¨æ¿ã€ç”˜ç‰¹åœ–æ’ç¨‹èˆ‡å³æ™‚å°ˆæ¡ˆç›£æ§ï¼Œå”åŠ©åœ˜éšŠé«˜æ•ˆå”ä½œã€‚">
    <meta name="author" content="UP YOUNG Marketing Department">
    <meta name="robots" content="noindex, nofollow">
    <link rel="shortcut icon" href="favicon.ico"> 

    <meta property="og:type" content="website">
    <meta property="og:title" content="ä¸Šæ´‹è¡ŒéŠ·æˆ°æƒ…å®¤">
    <meta property="og:description" content="ç™»å…¥æŸ¥çœ‹å°ˆæ¡ˆé€²åº¦ã€ç”˜ç‰¹åœ–èˆ‡å³æ™‚å¾…è¾¦äº‹é …ã€‚">
    <meta property="og:url" content=""> 
    <meta property="og:image" content="https://www.upyoung.com.tw/assets/images/logo.png"> 

    <meta name="theme-color" content="#4f46e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ä¸Šæ´‹è¡ŒéŠ·">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = { theme: { extend: { fontFamily: { sans: ['Inter', 'sans-serif'] }, colors: { slate: { 850: '#1e293b', 900: '#0f172a' } } } } }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .login-bg { background: linear-gradient(135deg, #4f46e5 0%, #0f172a 100%); }
        [v-cloak] { display: none !important; }
        
        /* Calendar Fixed Height (Strict) */
        .calendar-wrapper { display: flex; flex-direction: column; height: 100%; border-radius: 0.75rem; border: 1px solid #e2e8f0; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); background: white; }
        .calendar-header { display: grid; grid-template-columns: repeat(7, 1fr); background-color: #f8fafc; border-bottom: 1px solid #e2e8f0; flex-shrink: 0; }
        .calendar-header-cell { padding: 12px; text-align: center; font-size: 0.75rem; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; }
        /* Use block display for body to allow scrolling if needed, but we use grid inside */
        .calendar-body { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            /* ä¿®æ­£ï¼šå°‡å›ºå®šé«˜åº¦æ”¹ç‚º 1frï¼Œä½¿å…¶å‡åˆ†ç©ºé–“ä¸¦å¡«æ»¿é«˜åº¦ */
            grid-auto-rows: 1fr; 
            background-color: #e2e8f0; 
            gap: 1px; 
            flex: 1; 
            overflow: hidden; /* ç§»é™¤æ»¾å‹•æ¢ï¼Œç¢ºä¿å…¨æ»¿é¡¯ç¤º */
        }
        
        /* Strict Cell Sizing */
        .calendar-cell { 
            background-color: white; 
            padding: 4px; 
            /* ç§»é™¤å›ºå®š 120pxï¼Œè®“å®ƒè·Ÿéš¨ grid æ¯”ä¾‹ */
            height: 100%; 
            display: flex; 
            flex-direction: column; 
            transition: background-color 0.2s; 
            overflow: hidden; 
        }
        .calendar-cell:hover { background-color: #fcfcfc; }
        .calendar-cell.other-month { background-color: #f8fafc; opacity: 0.6; }
        .calendar-cell.today { background-color: #eff6ff; position: relative; }
        .calendar-cell.today::after { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background-color: #4f46e5; }
        .date-num { font-size: 0.75rem; font-weight: 600; color: #475569; margin-bottom: 2px; text-align: right; padding-right: 4px; }
        .today .date-num { color: #4f46e5; font-weight: 800; background: #e0e7ff; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-left: auto; }
        
        .event-pill { font-size: 9px; padding: 2px 4px; border-radius: 3px; margin-bottom: 2px; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: flex; align-items: center; font-weight: 500; border-left: 2px solid transparent; }
        .ep-deadline.status-completed { background-color: #ecfdf5; color: #065f46; border-left-color: #10b981; }
        .ep-deadline.status-active { background-color: #e0e7ff; color: #3730a3; border-left-color: #6366f1; }
        .ep-deadline.status-delayed { background-color: #fef2f2; color: #991b1b; border-left-color: #ef4444; }
        .ep-milestone { background-color: #f1f5f9; color: #475569; border: 1px solid #e2e8f0; border-left-width: 1px; }
        
        /* Draggable Gantt */
        .gantt-scroll-container { overflow-x: auto; overflow-y: hidden; border: 1px solid #e2e8f0; border-radius: 8px; background: white; cursor: grab; user-select: none; }
        .gantt-scroll-container:active { cursor: grabbing; }
        .gantt-header-row { display: flex; background: #f8fafc; border-bottom: 1px solid #e2e8f0; height: 32px; align-items: center; }
        .gantt-row { display: flex; border-bottom: 1px solid #f1f5f9; height: 40px; align-items: center; position: relative; transition: background 0.1s; }
        .gantt-row:hover { background-color: #f8fafc; }
        
        .gantt-label-col { position: sticky; left: 0; background: white; z-index: 20; border-right: 2px solid #e2e8f0; flex-shrink: 0; display: flex; align-items: center; height: 100%; box-shadow: 4px 0 6px -2px rgba(0,0,0,0.05); padding-left: 12px; font-size: 12px; font-weight: 600; color: #334155; width: 220px; }
        
        .gantt-timeline-area { display: flex; position: relative; height: 100%; }
        .gantt-day-cell { border-right: 1px solid #f1f5f9; height: 100%; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 9px; color: #94a3b8; }
        .gantt-day-cell.weekend { background-color: #f8fafc; }
        
        .gantt-bar { position: absolute; height: 24px; top: 8px; border-radius: 4px; font-size: 10px; color: white; display: flex; align-items: center; padding: 0 8px; overflow: hidden; white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.1); z-index: 10; transition: all 0.2s; cursor: pointer; }
        .gantt-bar:hover { filter: brightness(1.1); transform: translateY(-1px); }
        
        .chat-bubble { position: relative; max-width: 80%; }
        .chat-bubble::before { content: ""; position: absolute; top: 10px; border-style: solid; border-width: 6px; }
        .chat-left::before { left: -12px; border-color: transparent white transparent transparent; }
        .chat-right::before { right: -12px; border-color: transparent transparent transparent #eff6ff; }
    </style>
</head>
<body class="text-slate-800 h-screen w-screen overflow-hidden text-left antialiased">

    <div id="app" class="h-full w-full flex flex-col" v-cloak>
        <audio id="notification-sound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_1720817-*024.mp3" preload="auto"></audio>

        <div v-if="userParams && !dataReady" class="fixed inset-0 z-[10000] bg-slate-50 flex flex-col items-center justify-center">
            <div class="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin mb-4"></div>
            <div class="text-slate-500 font-bold animate-pulse text-sm">ç³»çµ±è¼‰å…¥ä¸­...</div>
        </div>

        <div v-if="!userParams" class="fixed inset-0 z-[9999] flex items-center justify-center login-bg">
            <div class="bg-white/95 backdrop-blur-sm p-10 rounded-2xl shadow-2xl w-[400px] fade-in">
                <div class="text-center mb-8"><h1 class="text-2xl font-bold text-slate-800">ä¸Šæ´‹è¡ŒéŠ·éƒ¨ æˆ°æƒ…å®¤</h1><p class="text-slate-500 text-sm mt-2">v1.1</p></div>
                <div v-if="authError" class="bg-red-50 text-red-600 p-3 rounded-lg text-sm mb-6 flex items-center"><i class="fas fa-exclamation-circle mr-2"></i> {{ authError }}</div>
                <div class="space-y-5">
                    <input v-model="authForm.email" type="email" class="w-full border rounded-lg px-3 py-2.5 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Email">
                    <input v-model="authForm.password" type="password" class="w-full border rounded-lg px-3 py-2.5 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Password">
                    <div v-if="isRegisterMode" class="space-y-5 pt-2 border-t border-slate-100 fade-in">
                        <input v-model="authForm.name" class="w-full border rounded-lg px-3 py-2.5 outline-none" placeholder="å§“å">
                        <div class="grid grid-cols-2 gap-4">
                            <select v-model="authForm.team" class="w-full border rounded-lg px-3 py-2.5 bg-white text-sm"><option value="digital">æ•¸ä½èª²</option><option value="brand">å“ç‰Œèª²</option><option value="pr">å…¬é—œèª²</option><option value="design">è¨­è¨ˆèª²</option><option value="mkgt">è¡ŒéŠ·éƒ¨</option></select>
                            <select v-model="authForm.role" class="w-full border rounded-lg px-3 py-2.5 bg-white text-sm"><option value="member">è·å“¡</option><option value="manager">èª²ä¸»ç®¡</option><option value="director">éƒ¨ä¸»ç®¡</option></select>
                        </div>
                    </div>
                    <button @click="handleAuth" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 transition">{{ isRegisterMode ? 'è¨»å†Š' : 'ç™»å…¥' }}</button>
                    <div class="text-center mt-6"><button @click="toggleAuthMode" class="text-xs text-indigo-600 hover:underline">{{ isRegisterMode ? 'è¿”å›ç™»å…¥' : 'è¨»å†Šæ–°å¸³è™Ÿ' }}</button></div>
                </div>
            </div>
        </div>

        <template v-else-if="dataReady">
            <header class="bg-white border-b border-slate-200 h-16 flex items-center px-4 md:px-6 justify-between flex-shrink-0 z-20 relative shadow-sm">
                <div class="font-bold text-xl flex items-center tracking-tight text-slate-800">
                    <button @click="showMobileSidebar = !showMobileSidebar" class="mr-4 text-slate-500 hover:text-indigo-600 md:hidden">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                    <div class="w-8 h-8 rounded bg-indigo-600 flex items-center justify-center text-white text-xs mr-3 flex-shrink-0">
                        <i class="fas fa-rocket"></i>
                    </div>
                    <span class="hidden md:inline">ä¸Šæ´‹è¡ŒéŠ·éƒ¨</span>
                    <span class="md:hidden">ä¸Šæ´‹è¡ŒéŠ·</span>
                    <span class="font-normal text-slate-400 mx-2">/</span> 
                    <span class="text-sm md:text-xl">æˆ°æƒ…å®¤</span>
                </div>
                <div class="flex items-center gap-4">
                    <div class="relative">
                        <div @click="showNotifications = !showNotifications" class="w-9 h-9 rounded-full bg-slate-50 hover:bg-slate-100 text-slate-500 flex items-center justify-center cursor-pointer transition relative">
                            <i class="fas fa-bell"></i>
                            <span v-if="unreadNotificationsCount > 0" class="absolute top-0 right-0 w-3 h-3 bg-red-500 border-2 border-white rounded-full"></span>
                        </div>
                        <div v-if="showNotifications" class="absolute right-0 top-12 w-80 bg-white rounded-xl shadow-2xl border border-slate-100 overflow-hidden z-50 fade-in">
                            <div class="px-4 py-3 border-b text-xs font-bold text-slate-500 bg-slate-50 flex justify-between items-center"><span>é€šçŸ¥ä¸­å¿ƒ</span><button v-if="notifications.length > 0" @click="clearAllNotifications" class="text-indigo-600 hover:underline">å…¨éƒ¨æ¸…é™¤</button></div>
                            <div class="max-h-80 overflow-y-auto"><div v-if="notifications.length === 0" class="p-8 text-center text-slate-400 text-xs italic">ç„¡æ–°é€šçŸ¥</div><div v-for="n in notifications" :key="n.id" @click="handleNotificationClick(n)" :class="['p-3 border-b hover:bg-indigo-50 cursor-pointer transition flex items-start gap-3', n.read ? 'opacity-50' : 'bg-white']"><div class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center flex-shrink-0 text-xs"><i class="fas" :class="n.type === 'handoff' ? 'fa-exchange-alt' : 'fa-tasks'"></i></div><div><div class="text-xs font-bold text-slate-700 mb-0.5">{{ n.title }}</div><div class="text-[10px] text-slate-500">{{ n.message }}</div><div class="text-[8px] text-slate-300 mt-1">{{ n.time }}</div></div></div></div>
                        </div>
                    </div>
                    <div class="text-right hidden md:block"><div class="text-sm font-bold text-slate-700">{{ currentUser?.name || 'Loading...' }}</div><div class="text-[10px] text-slate-400 font-medium uppercase">{{ teamMap[currentUser?.team] }} â€¢ {{ roleMap[currentUser?.role] }}</div></div>
                    <div class="w-9 h-9 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center font-bold border border-indigo-100 cursor-pointer hover:bg-red-50 hover:text-red-600 transition" @click="logout" title="ç™»å‡º">{{ (currentUser?.name || 'U').substring(0,1) }}</div>
                </div>
            </header>

            <div class="flex flex-1 w-full overflow-hidden items-stretch relative" @click="showNotifications=false">
                
                <!-- æ‰‹æ©Ÿç‰ˆé®ç½©å±¤ -->
                <div v-if="showMobileSidebar" @click="showMobileSidebar = false" class="fixed inset-0 bg-slate-900/80 z-30 md:hidden fade-in"></div>
                
                <div :class="['bg-slate-900 text-slate-300 flex flex-col shadow-inner flex-shrink-0 h-full border-r border-slate-800 transition-transform duration-300 ease-in-out md:translate-x-0 md:relative fixed z-40 w-64', showMobileSidebar ? 'translate-x-0' : '-translate-x-full']">
                    <div class="flex-1 overflow-y-auto no-scrollbar py-4">
                        <div class="px-3 mb-4 space-y-1">
                            <button @click="currentView = 'dashboard'; filterStatus = 'all'; showMobileSidebar = false" :class="['w-full text-left px-3 py-2.5 rounded-lg flex items-center transition', currentView === 'dashboard' ? 'bg-indigo-600 text-white' : 'hover:bg-slate-800']"><i class="fas fa-chart-pie w-6 opacity-70"></i> æˆ°æƒ…å„€è¡¨æ¿</button>
                            <button @click="currentView = 'history_report'; showMobileSidebar = false" :class="['w-full text-left px-3 py-2.5 rounded-lg flex items-center transition', currentView === 'history_report' ? 'bg-indigo-600 text-white' : 'hover:bg-slate-800']"><i class="fas fa-history w-6 opacity-70"></i> æ­·å²ç¸¾æ•ˆå ±è¡¨</button>
                            <button @click="currentView = 'my_workspace'; workspaceTab='tasks'; showMobileSidebar = false" :class="['w-full text-left px-3 py-2.5 rounded-lg flex items-center transition', currentView === 'my_workspace' ? 'bg-indigo-600 text-white' : 'hover:bg-slate-800']"><i class="fas fa-tasks w-6 opacity-70"></i> æˆ‘çš„å·¥ä½œå€</button>
                        </div>
                        <div class="px-3 mb-2"><div class="relative"><input v-model="sidebarSearch" type="text" class="w-full bg-slate-800 border border-slate-700 rounded-lg py-1.5 pl-8 pr-3 text-xs text-slate-300 placeholder-slate-500 outline-none focus:border-indigo-500" placeholder="æœå°‹å°ˆæ¡ˆæˆ–å“ç‰Œ..."><i class="fas fa-search absolute left-2.5 top-2 text-slate-500 text-xs"></i></div></div>
                        <div class="px-2 mt-2">
                            <div class="flex justify-between items-center px-3 mb-2"><span class="text-[10px] text-slate-500 uppercase font-bold tracking-wider">å“ç‰Œ</span><button @click="addBrand" class="text-slate-500 hover:text-white text-xs bg-slate-800 w-5 h-5 rounded flex items-center justify-center transition"><i class="fas fa-plus"></i></button></div>
                            <div v-for="brand in visibleBrands" :key="brand.id" class="mb-2">
                                <div @click="toggleBrand(brand.id)" class="px-3 py-1.5 text-xs font-bold text-slate-400 hover:text-white cursor-pointer flex items-center group transition hover:bg-slate-800 rounded"><i :class="['fas mr-2 text-[10px] w-3 transition-transform', isBrandExpanded(brand.id) ? 'fa-chevron-down' : 'fa-chevron-right']"></i><span class="flex-1 truncate">{{ brand.name }}</span><button @click.stop="openProjectModal(brand.id)" class="opacity-0 group-hover:opacity-100 text-slate-500 hover:text-white transition px-1" title="é–‹ç«‹å°ˆæ¡ˆ">+</button></div>
                                <div v-show="isBrandExpanded(brand.id)" class="mt-1">
                                    <div v-for="proj in getMatchingProjects(brand.id)" :key="proj.id" class="mb-1">
                                        <div @click="toggleExpand(proj); selectParentProject(proj)" :class="['flex items-center justify-between px-3 py-2 cursor-pointer text-sm group transition rounded-lg relative ml-2', (currentParentProject?.id === proj.id) ? 'bg-slate-800 text-white' : 'hover:bg-slate-800/50 hover:text-white']"><div class="flex items-center truncate w-full"><i :class="['fas text-[10px] w-4 transition mr-1', proj.expanded ? 'rotate-90' : '']"></i> <span class="truncate">{{ proj.title }}</span></div><button @click.stop="openBranchModal(proj.id)" class="opacity-0 group-hover:opacity-100 text-[10px] bg-indigo-600 px-1.5 py-0.5 rounded text-white ml-2 hover:bg-indigo-500 transition"><i class="fas fa-plus"></i></button></div>
                                        <div v-if="proj.expanded" class="ml-6 border-l border-slate-700 pl-2 space-y-0.5 mt-1 mb-2 fade-in">
                                            <div v-for="sp in (getSubsForParent(proj.id))" :key="sp.id" @click.stop="selectSubProject(sp, proj)" :class="['text-xs cursor-pointer px-3 py-1.5 rounded-md truncate flex justify-between items-center transition hover:bg-slate-800', (currentView === 'sub_project_detail' && currentSubProject?.id === sp.id) ? 'text-indigo-300 bg-slate-800 font-medium' : 'text-slate-500 hover:text-slate-200']"><span class="truncate">{{ sp.title }}</span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="p-3 border-t border-slate-800 bg-slate-900/50">
                        <div @click="showArchived = !showArchived" class="px-3 py-2 text-xs font-bold text-slate-500 hover:text-slate-300 cursor-pointer flex justify-between items-center rounded-lg hover:bg-slate-800 transition"><span><i class="fas fa-archive mr-2"></i> å·²æ­¸æª”/ä¸­æ­¢</span><i :class="['fas transition', showArchived ? 'rotate-180' : '']"></i></div>
                        <div v-if="showArchived" class="mt-2 space-y-1 max-h-48 overflow-y-auto bg-slate-800 rounded-lg p-2 border border-slate-700 fade-in"><div v-for="brand in sortedBrands" :key="'arch-'+brand.id"><div v-if="getArchivedProjectsByBrand(brand.id).length > 0"><div class="px-2 py-1 text-[10px] font-bold text-indigo-400 uppercase tracking-wider mt-2 mb-1 border-b border-slate-700">{{ brand.name }}</div><div v-for="proj in getArchivedProjectsByBrand(brand.id)" :key="proj.id" @click="selectParentProject(proj)" class="text-xs text-slate-400 hover:text-white cursor-pointer truncate px-2 py-1 rounded hover:bg-slate-700 flex items-center"><i class="fas fa-check-circle text-emerald-500 mr-2" v-if="proj.status==='completed'"></i><i class="fas fa-ban text-red-400 mr-2" v-else-if="proj.status==='aborted'"></i> {{ proj.title }}</div></div></div></div>
                    </div>
                </div>

                <div class="flex-1 flex flex-col bg-slate-50 overflow-hidden relative items-start w-full" @click.stop>
                    
                    <div v-if="currentView === 'dashboard'" class="flex-1 overflow-y-auto p-8 w-full fade-in">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 w-full gap-4">
                            <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-3">è¡ŒéŠ·éƒ¨ å°ˆæ¡ˆç¸½è¦½<span class="text-sm font-normal text-slate-400 bg-white border px-2 py-1 rounded-full">Current Active</span></h2>
                            <div class="flex flex-wrap gap-2">
                                <select v-model="selectedDashboardBrand" class="border border-slate-300 rounded-lg px-3 py-1.5 text-sm bg-white font-bold text-slate-600 outline-none focus:ring-2 focus:ring-indigo-500"><option value="all">æ‰€æœ‰å“ç‰Œ</option><option v-for="b in sortedBrands" :value="b.id">{{ b.name }}</option></select>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 w-full">
                            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200"><div class="flex justify-between items-start mb-4"><div class="text-xs font-bold text-slate-500 uppercase">åŸ·è¡Œä¸­æ¡ˆä»¶</div><div class="w-8 h-8 rounded-full bg-blue-100 text-blue-500 flex items-center justify-center"><i class="fas fa-running"></i></div></div><div class="text-3xl font-bold text-slate-800">{{ scopedStats.active?.count || 0 }}</div></div>
                            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200"><div class="flex justify-between items-start mb-4"><div class="text-xs font-bold text-slate-500 uppercase">ç•¶å‰å»¶é²ç‡</div><div class="w-8 h-8 rounded-full bg-orange-100 text-orange-500 flex items-center justify-center"><i class="fas fa-chart-line"></i></div></div><div class="text-3xl font-bold text-orange-600">{{ scopedStats.active?.delayRate || 0 }}<span class="text-sm">%</span></div></div>
                            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200"><div class="flex justify-between items-start mb-4"><div class="text-xs font-bold text-slate-500 uppercase">ç•¶å‰å»¶é²å¤©æ•¸</div><div class="w-8 h-8 rounded-full bg-red-100 text-red-500 flex items-center justify-center"><i class="fas fa-clock"></i></div></div><div class="text-3xl font-bold text-red-600">{{ scopedStats.active?.totalDelayDays || 0 }} <span class="text-sm font-normal text-slate-400">å¤©</span></div></div>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-8">
                            <div class="px-6 py-4 border-b border-slate-100 bg-red-50/50 flex justify-between items-center"><h3 class="font-bold text-red-800"><i class="fas fa-bolt mr-2"></i> åŸ·è¡Œä¸­å°ˆæ¡ˆå»¶é²åŸå› </h3></div>
                            <div class="p-6"><div v-if="!scopedStats?.active?.reasonList || scopedStats.active.reasonList.length===0" class="text-center text-slate-400 text-sm">å°šç„¡è³‡æ–™</div><div class="space-y-4" v-else><div v-for="r in scopedStats.active.reasonList" :key="r.name" class="flex items-center"><div class="w-24 text-xs font-bold text-slate-600 text-right mr-4">{{ r.name }}</div><div class="flex-1 bg-slate-100 rounded-full h-3 relative"><div class="bg-red-500 h-3 rounded-full" :style="{width: r.percent + '%'}"></div></div><div class="w-16 text-xs font-bold text-red-600 ml-4 text-right">{{ r.count }} ({{ r.percent }}%)</div></div></div></div>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 mb-8 w-full overflow-hidden">
                            <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center"><h3 class="font-bold text-slate-700"><i class="fas fa-satellite-dish mr-2 text-indigo-500"></i> åŸ·è¡Œç›£æ§ </h3><button v-if="filterStatus!=='all'" @click="filterStatus='all'" class="text-xs text-indigo-600 hover:underline">é¡¯ç¤ºå…¨éƒ¨</button></div>
                            <div class="overflow-x-auto w-full"><table class="w-full text-sm text-left"><thead class="text-xs text-slate-500 uppercase bg-slate-50 border-b"><tr><th class="px-6 py-3">å“ç‰Œ / å°ˆæ¡ˆ / åˆ†æ”¯</th><th class="px-6 py-3">è² è²¬äºº</th><th class="px-6 py-3">ç›®å‰è™•ç† / æ»¯ç•™</th><th class="px-6 py-3 text-center">æˆªæ­¢æ—¥</th><th class="px-6 py-3 text-center">å¯¦éš›å·¥æ™‚</th><th class="px-6 py-3">ç‹€æ…‹</th></tr></thead><tbody class="divide-y divide-slate-100"><tr v-if="filteredMonitorList.length===0"><td colspan="6" class="px-6 py-4 text-center text-slate-400">å°šç„¡è³‡æ–™</td></tr><tr v-for="item in filteredMonitorList" :key="item.branch.id" class="hover:bg-slate-50 transition cursor-pointer" @click="selectSubProject(item.branch, item.parent)"><td class="px-6 py-3"><div class="text-xs text-slate-400 flex items-center gap-1 mb-1"><span class="bg-indigo-50 text-indigo-600 px-1.5 py-0.5 rounded font-bold">{{ item?.brand?.name || 'Unknown' }}</span><i class="fas fa-chevron-right text-[8px]"></i><span>{{ item?.parent?.title || 'Unknown' }}</span></div><div class="font-bold text-slate-800 pl-1">{{ item.branch.title }}</div></td><td class="px-6 py-3 flex items-center"><div class="w-6 h-6 rounded bg-slate-200 text-slate-600 text-xs flex justify-center items-center mr-2">{{ (item.branch.assignee || 'U').substring(0,1) }}</div>{{ item.branch.assignee }}</td><td class="px-6 py-3"><div class="flex flex-col"><span class="font-bold text-indigo-700 text-xs">{{ item.branch.currentHandler || item.branch.assignee }}</span><span class="text-[10px] text-slate-400 mt-0.5">æ»¯ç•™ {{ getDaysHeld(item.branch.lastHandoffDate) }} å¤©</span></div></td><td class="px-6 py-3 text-center font-mono" :class="getDateStyle(item.branch.endDate)">{{ item.branch.endDate||'--' }}</td><td class="px-6 py-3 text-center font-bold text-blue-600">{{ calcSubProjectHours(item.branch) }} h</td><td class="px-6 py-3"><span v-if="getProjectHealth(item.branch).type === 'delay'" class="bg-red-100 text-red-700 px-2 py-1 rounded text-xs font-bold">ğŸ”´ å»¶é² {{ getProjectHealth(item.branch).days }} å¤©</span><span v-else-if="getProjectHealth(item.branch).type === 'lag'" class="bg-orange-100 text-orange-700 px-2 py-1 rounded text-xs font-bold">ğŸŸ  è½å¾Œ {{ getProjectHealth(item.branch).days }} å¤©</span><span v-else class="bg-emerald-100 text-emerald-700 px-2 py-1 rounded text-xs font-bold">ğŸŸ¢ æ­£å¸¸</span></td></tr></tbody></table></div>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 w-full overflow-hidden">
                            <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50"><h3 class="font-bold text-slate-700"><i class="fas fa-users-cog mr-2 text-indigo-500"></i> äººå“¡ç”¢èƒ½ (ç•¶å‰ç‹€æ…‹)</h3></div>
                            <div class="overflow-x-auto w-full">
                                <table class="w-full text-sm text-left">
                                    <thead class="text-xs text-slate-500 uppercase bg-slate-50 border-b">
                                        <tr>
                                            <th class="px-6 py-3">æˆå“¡</th>
                                            <th class="px-6 py-3 text-center">åŸ·è¡Œä¸­æ¡ˆä»¶</th>
                                            <th class="px-6 py-3 text-right">ç•°å¸¸</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-100">
                                        <tr v-for="m in memberStats" :key="m.id" class="hover:bg-indigo-50 cursor-pointer transition relative z-10" @click="openMemberDetail(m)">
                                            <td class="px-6 py-3 font-bold text-slate-700">
                                                <span class="text-[10px] bg-slate-100 border border-slate-200 text-slate-500 px-1.5 py-0.5 rounded mr-2 uppercase">{{ teamMap[m.team] || 'N/A' }}</span>{{ m.name }}
                                            </td>
                                            <td class="px-6 py-3 text-center">
                                                <span :class="['px-2 py-1 rounded text-xs font-bold', m.activeBranches>3?'bg-orange-100 text-orange-700':'bg-slate-100']">{{ m.activeBranches }}</span>
                                            </td>
                                            <td class="px-6 py-3 text-right">
                                                <span v-if="m.delayCount>0" class="text-red-500 text-xs font-bold">{{ m.delayCount }} å»¶èª¤</span>
                                                <span v-else class="text-emerald-500 text-xs font-bold">æ­£å¸¸</span>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div v-if="currentView === 'history_report'" class="flex-1 overflow-y-auto p-8 w-full fade-in">
                         <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 w-full gap-4">
                            <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-3">
                                <i class="fas fa-history text-indigo-500"></i> æ­·å²ç¸¾æ•ˆå ±è¡¨<span class="text-sm font-normal text-slate-400 bg-white border px-2 py-1 rounded-full">{{ currentYear }} / {{ currentMonth === 'all' ? 'All' : currentMonth }}</span></h2><div class="flex flex-wrap gap-2 items-center"><button @click="exportHistoryReport" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-1.5 rounded-lg text-xs font-bold transition mr-2 flex items-center"><i class="fas fa-file-export mr-2"></i> åŒ¯å‡ºå ±è¡¨</button><select v-model="selectedDashboardBrand" class="border border-slate-300 rounded-lg px-3 py-1.5 text-sm bg-white font-bold text-slate-600 outline-none focus:ring-2 focus:ring-indigo-500"><option value="all">æ‰€æœ‰å“ç‰Œ</option><option v-for="b in sortedBrands" :value="b.id">{{ b.name }}</option></select><select v-model="currentYear" class="border border-slate-300 rounded-lg px-3 py-1.5 text-sm bg-white font-bold text-slate-600 outline-none focus:ring-2 focus:ring-indigo-500"><option v-for="y in [2023,2024,2025,2026]" :value="y">{{ y }}å¹´</option></select><select v-model="currentMonth" class="border border-slate-300 rounded-lg px-3 py-1.5 text-sm bg-white font-bold text-slate-600 outline-none focus:ring-2 focus:ring-indigo-500"><option value="all">å…¨å¹´</option><option v-for="m in 12" :value="m">{{ m }}æœˆ</option></select></div></div>
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8 w-full">
                                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                                        <div class="flex justify-between items-start mb-4">
                                            <div class="text-xs font-bold text-slate-500 uppercase">ç¸½çµæ¡ˆé‡</div>
                                            <div class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center">
                                                <i class="fas fa-folder"></i>
                                            </div>
                                        </div>
                                        <div class="text-3xl font-bold text-slate-800">{{ scopedStats.overall?.totalProjects || 0 }}
                                        </div>
                                    </div>
                                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                                        <div class="flex justify-between items-start mb-4">
                                            <div class="text-xs font-bold text-slate-500 uppercase">ç¸½é«”å»¶é²ç‡</div>
                                            <div class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-500 flex items-center justify-center">
                                                <i class="fas fa-percentage"></i>
                                            </div>
                                        </div>
                                        <div class="text-3xl font-bold text-indigo-600">{{ scopedStats.overall?.delayRate || 0 }}
                                            <span class="text-sm">%</span>
                                        </div>
                                    </div>
                                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                                        <div class="flex justify-between items-start mb-4">
                                            <div class="text-xs font-bold text-slate-500 uppercase">ç´¯ç©å»¶é²å¤©æ•¸</div>
                                            <div class="w-8 h-8 rounded-full bg-pink-100 text-pink-500 flex items-center justify-center">
                                                <i class="fas fa-history"></i>
                                            </div>
                                        </div>
                                        <div class="text-3xl font-bold text-pink-600">{{ scopedStats.overall?.totalDelayDays || 0 }} 
                                            <span class="text-sm font-normal text-slate-400">å¤©</span>
                                        </div>
                                    </div>
                                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                                        <div class="flex justify-between items-start mb-4">
                                            <div class="text-xs font-bold text-slate-500 uppercase">æœŸé–“æ­¸æª”å·¥æ™‚</div>
                                            <div class="w-8 h-8 rounded-full bg-emerald-100 text-emerald-500 flex items-center justify-center">
                                                <i class="fas fa-archive"></i>
                                            </div>
                                        </div>
                                        <div class="text-3xl font-bold text-slate-800">{{ scopedStats?.archivedHours || 0 }}
                                             <span class="text-sm font-medium text-slate-400">h</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-1 gap-6 mb-8 w-full">
                                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                                            <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                                                <h3 class="font-bold text-slate-700">
                                                    <i class="fas fa-archive mr-2"></i> æ­·å²å»¶é²èˆ‡ä¸­æ­¢åŸå› åˆ†æ</h3>
                                            </div>
                                            <div class="p-6">
                                                <div v-if="!scopedStats?.overall?.reasonList || scopedStats.overall.reasonList.length===0" class="text-center text-slate-400 text-sm">å°šç„¡è³‡æ–™</div>
                                                <div class="space-y-4" v-else>
                                                    <div v-for="r in scopedStats.overall.reasonList" :key="r.name" class="flex items-center">
                                                        <div class="w-24 text-xs font-bold text-slate-600 text-right mr-4">{{ r.name }}</div>
                                                        <div class="flex-1 bg-slate-100 rounded-full h-3 relative">
                                                            <div class="bg-indigo-500 h-3 rounded-full" :style="{width: r.percent + '%'}"></div>
                                                        </div>
                                                        <div class="w-16 text-xs font-bold text-indigo-600 ml-4 text-right">{{ r.count }} ({{ r.percent }}%)</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 mb-8 w-full overflow-hidden">
                                        <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50">
                                            <h3 class="font-bold text-slate-700">æ­¸æª”å°ˆæ¡ˆåˆ—è¡¨</h3>
                                        </div>
                                        <div class="overflow-x-auto w-full">
                                            <table class="w-full text-sm text-left">
                                                <thead class="text-xs text-slate-500 uppercase bg-slate-50 border-b">
                                                    <tr><th class="px-6 py-3">å“ç‰Œ / å°ˆæ¡ˆ / åˆ†æ”¯</th>
                                                        <th class="px-6 py-3">è² è²¬äºº</th>
                                                        <th class="px-6 py-3 text-center">çµæ¡ˆæ—¥</th>
                                                        <th class="px-6 py-3 text-center">ç¸½å·¥æ™‚</th>
                                                        <th class="px-6 py-3">æœ€çµ‚ç‹€æ…‹</th>
                                                    </tr>
                                                </thead>
                                                <tbody class="divide-y divide-slate-100">
                                                    <tr v-if="scopedStats.archivedList.length===0">
                                                        <td colspan="5" class="px-6 py-4 text-center text-slate-400">å°šç„¡æ­¸æª”è³‡æ–™</td>
                                                    </tr>
                                                    <tr v-for="item in scopedStats.archivedList" :key="item.branch.id" class="hover:bg-slate-50 transition cursor-pointer" @click="selectSubProject(item.branch, item.parent)">
                                                        <td class="px-6 py-3">
                                                            <div class="text-xs text-slate-400 mb-1">{{ item.brand.name }} / {{ item.parent.title }}</div>
                                                            <div class="font-bold text-slate-800">{{ item.branch.title }}</div>
                                                        </td>
                                                        <td class="px-6 py-3">{{ item.branch.assignee }}</td>
                                                        <td class="px-6 py-3 text-center font-mono">{{ item.branch.endDate }}</td>
                                                        <td class="px-6 py-3 text-center font-bold text-blue-600">{{ item.branch.actHours }} h</td>
                                                        <td class="px-6 py-3">
                                                            <span :class="['px-2 py-1 rounded text-xs font-bold', item.branch.status==='aborted'?'bg-slate-200 text-slate-600':'bg-emerald-100 text-emerald-700']">{{ item.branch.status==='aborted'?'å·²ä¸­æ­¢':(item.branch.finalDelayDays > 0 ? `å»¶èª¤ ${item.branch.finalDelayDays} å¤©` : 'æº–æ™‚') }}</span>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 w-full">
                                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                                            <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                                                <h3 class="font-bold text-slate-700"><i class="fas fa-chart-pie mr-2 text-indigo-500"></i> å„å–®ä½å·¥æ™‚çµ±è¨ˆ</h3>
                                            </div>
                                            <div class="p-6">
                                                <div v-for="team in departmentHours" :key="team.name" class="flex items-center mb-3 last:mb-0">
                                                    <div class="w-24 text-xs font-bold text-slate-500 uppercase mr-3">{{ teamMap[team.name] || team.name }}</div>
                                                    <div class="flex-1 h-2 bg-slate-100 rounded-full mr-3">
                                                        <div class="h-2 bg-indigo-500 rounded-full" :style="{ width: (team.percent) + '%' }"></div>
                                                    </div>
                                                    <div class="w-16 text-right text-xs font-bold text-slate-700">{{ team.hours }} h</div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col max-h-80">
                                            <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                                                <h3 class="font-bold text-slate-700"><i class="fas fa-user-clock mr-2 text-indigo-500"></i> äººå“¡è©³ç´°å·¥æ™‚</h3>
                                            </div>
                                            <div class="flex-1 overflow-y-auto p-0">
                                                <table class="w-full text-sm text-left">
                                                    <thead class="text-xs text-slate-500 uppercase bg-slate-50 sticky top-0">
                                                        <tr><th class="px-6 py-2">æˆå“¡</th><th class="px-6 py-2 text-right">å·¥æ™‚</th></tr>
                                                    </thead>
                                                    <tbody class="divide-y divide-slate-100">
                                                        <tr v-for="m in memberHoursStats" :key="m.name">
                                                            <td class="px-6 py-2 text-slate-600 font-bold">
                                                                <span class="text-[10px] bg-slate-100 border border-slate-200 text-slate-400 px-1.5 py-0.5 rounded mr-2 uppercase">{{ teamMap[m.team] }}</span>{{ m.name }}
                                                            </td>
                                                            <td class="px-6 py-2 text-right font-mono text-indigo-600 font-bold">{{ m.hours }} h</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                    </div>

                    <div v-if="currentView === 'my_workspace'" class="flex-1 flex flex-col h-full bg-slate-50 fade-in w-full">
                        <div class="px-8 pt-2 pb-4">
                             <div class="flex gap-4 border-b border-slate-200">
                                <button @click="workspaceTab = 'tasks'" :class="['px-4 py-2 font-bold text-sm transition border-b-2', workspaceTab==='tasks'?'border-indigo-600 text-indigo-600':'border-transparent text-slate-400 hover:text-slate-600']">å¾…è¾¦æ¸…å–®</button>
                                <button @click="workspaceTab = 'calendar'" :class="['px-4 py-2 font-bold text-sm transition border-b-2', workspaceTab==='calendar'?'border-indigo-600 text-indigo-600':'border-transparent text-slate-400 hover:text-slate-600']">å°ˆæ¡ˆè¡Œäº‹æ›†</button>
                             </div>
                        </div>

                        <div v-if="workspaceTab === 'tasks'" class="flex-1 overflow-y-auto px-8 pb-8">
                            <div class="mb-8"><h3 class="text-lg font-bold text-indigo-700 mb-3 flex items-center"><i class="fas fa-hand-holding mr-2"></i> ç›®å‰å¾…è¾¦ (My Tasks) <span class="ml-2 text-xs bg-indigo-100 text-indigo-600 px-2 py-0.5 rounded-full">{{ myHandledBranches.length }}</span></h3><div v-if="myHandledBranches.length === 0" class="text-slate-400 text-sm italic bg-white p-4 rounded-lg border border-slate-200 text-center">ç›®å‰æ‰‹ä¸Šç„¡å¾…è¾¦äº‹é …ï¼Œå»å–æ¯å’–å•¡å§ï¼â˜•</div><div class="space-y-3"><div v-for="item in myHandledBranches" :key="item.sub.id" @click="selectSubProject(item.sub, item.parent)" class="flex items-center p-5 bg-white border rounded-xl hover:shadow-md cursor-pointer transition relative group" :class="getProjectHealth(item.sub).type !== 'normal' ? 'border-l-4 border-l-red-500 border-red-200 bg-red-50/10' : 'border-l-4 border-l-indigo-500 border-slate-200'"><div class="flex-1"><div class="text-xs text-slate-400 mb-1 flex items-center gap-2"><span class="bg-slate-100 text-slate-600 px-1.5 py-0.5 rounded font-bold">{{ item?.brand?.name || 'Unknown' }}</span><i class="fas fa-chevron-right text-[8px]"></i> {{ item.parent.title }}</div><div class="font-bold text-lg text-slate-800 flex items-center">{{ item.sub.title }} <span v-if="getProjectHealth(item.sub).type === 'delay'" class="ml-2 text-[10px] bg-red-100 text-red-600 px-2 py-0.5 rounded font-bold border border-red-200 animate-pulse">å»¶èª¤ {{ getProjectHealth(item.sub).days }} å¤©</span><span v-else-if="getProjectHealth(item.sub).type === 'lag'" class="ml-2 text-[10px] bg-orange-100 text-orange-600 px-2 py-0.5 rounded font-bold border border-orange-200">è½å¾Œ {{ getProjectHealth(item.sub).days }} å¤©</span></div><div class="text-xs text-indigo-600 mt-1 font-bold flex items-center"><i class="fas fa-stopwatch mr-1"></i> å·²æŒæœ‰ {{ getDaysHeld(item.sub.lastHandoffDate) }} å¤©</div></div><div class="text-right text-xs text-slate-500"><div class="font-mono mb-1">{{ item.sub.endDate || 'è¦åŠƒä¸­' }} æˆªæ­¢</div><div class="px-2 py-1 bg-slate-100 rounded inline-block">{{ statusMap[item.sub.status] }}</div></div></div></div></div><div><h3 class="text-lg font-bold text-slate-600 mb-3 flex items-center"><i class="fas fa-user-tie mr-2"></i> æˆ‘è² è²¬çš„å°ˆæ¡ˆ (Owned) <span class="ml-2 text-xs bg-slate-200 text-slate-600 px-2 py-0.5 rounded-full">{{ myOwnedBranches.length }}</span></h3><div v-if="myOwnedBranches.length === 0" class="text-slate-400 text-sm italic bg-white p-4 rounded-lg border border-slate-200 text-center">ç„¡è² è²¬å°ˆæ¡ˆ</div><div class="space-y-3"><div v-for="item in myOwnedBranches" :key="item.isParent ? ('p'+item.project.id) : ('s'+item.sub.id)" @click="item.isParent ? selectParentProject(item.project) : selectSubProject(item.sub, item.parent)" class="flex items-center p-4 bg-white border border-slate-200 rounded-lg hover:shadow-sm cursor-pointer transition opacity-90 hover:opacity-100" :class="item.isParent ? 'bg-slate-50 border-l-4 border-l-slate-800' : ''"><div v-if="item.isParent" class="flex-1"><div class="flex items-center gap-2 mb-1"><span class="text-[10px] bg-slate-800 text-white px-1.5 py-0.5 rounded uppercase font-bold">PARENT</span><span class="text-xs text-slate-500 font-bold">{{ item?.brand?.name || 'Unknown' }}</span></div><div class="font-bold text-slate-800 text-lg">{{ item.project.title }}</div></div><div v-else class="flex-1"><div class="text-xs text-slate-400 mb-1">{{ item?.brand?.name || 'Unknown' }} / {{ item.parent.title }}</div><div class="font-bold text-slate-700 flex items-center">{{ item.sub.title }}<span v-if="!item.isParent && getProjectHealth(item.sub).type === 'delay'" class="ml-2 bg-red-100 text-red-600 text-[10px] px-1 rounded">å»¶é² {{ getProjectHealth(item.sub).days }} å¤©</span><span v-if="!item.isParent && getProjectHealth(item.sub).type === 'lag'" class="ml-2 bg-orange-100 text-orange-600 text-[10px] px-1 rounded">è½å¾Œ {{ getProjectHealth(item.sub).days }} å¤©</span></div><div class="text-xs text-slate-500 mt-1">ç›®å‰è™•ç†ï¼š<span class="font-bold text-indigo-600">{{ item.sub.currentHandler }}</span></div></div><div class="text-right text-xs"><div v-if="!item.isParent" :class="getProjectHealth(item.sub).type !== 'normal'?'text-red-500 font-bold':''">{{ item.sub.endDate }}</div><div v-else class="text-slate-400">{{ item.project.endDate }}</div></div></div></div></div>
                        </div>

                        <div v-if="workspaceTab === 'calendar'" class="flex-1 flex flex-col p-6 h-full relative">
                            <div class="calendar-wrapper bg-white flex flex-row h-full">
                                <div class="flex-1 flex flex-col border-r border-slate-200">
                                    <div class="px-6 py-4 border-b flex justify-between items-center bg-white">
                                        <h2 class="text-xl font-bold text-slate-800 flex items-center"><i class="fas fa-calendar-alt text-indigo-500 mr-3"></i> å°ˆæ¡ˆè¡Œäº‹æ›†</h2>
                                        <div class="flex items-center gap-3 bg-slate-100 rounded-lg p-1">
                                            <button @click="changeMonth(-1)" class="w-8 h-8 flex items-center justify-center hover:bg-white hover:shadow-sm rounded-md transition text-slate-500"><i class="fas fa-chevron-left"></i></button>
                                            <span class="font-bold text-base w-32 text-center text-slate-700">{{ calendarYear }}å¹´ {{ calendarMonth }}æœˆ</span>
                                            <button @click="changeMonth(1)" class="w-8 h-8 flex items-center justify-center hover:bg-white hover:shadow-sm rounded-md transition text-slate-500"><i class="fas fa-chevron-right"></i></button>
                                        </div>
                                        <div class="text-[10px] text-slate-400 font-bold">MS = Milestone (é‡Œç¨‹ç¢‘)</div>
                                    </div>
                                    <div class="flex-1 flex flex-col overflow-hidden"><div class="calendar-header"><div v-for="d in ['é€±æ—¥','é€±ä¸€','é€±äºŒ','é€±ä¸‰','é€±å››','é€±äº”','é€±å…­']" :key="d" class="calendar-header-cell">{{ d }}</div></div><div class="calendar-body no-scrollbar"><div v-for="(day, idx) in calendarDays" :key="idx" :class="['calendar-cell', day.isCurrentMonth ? 'bg-white' : 'other-month', day.isToday ? 'today' : '']"><div class="date-num">{{ day.date }}</div><div class="flex-1 overflow-y-hidden space-y-1 px-1 pb-1"><div v-for="ev in day.events.slice(0,3)" :key="ev.id" @click.stop="openCalendarSideEvent(ev)" :class="['event-pill', ev.type === 'deadline' ? (ev.sub.status==='completed' ? 'ep-deadline status-completed' : (getProjectHealth(ev.sub).type !== 'normal' ? 'ep-deadline status-delayed' : 'ep-deadline status-active')) : 'ep-milestone']" :title="ev.title"><i class="fas mr-1 text-[8px]" :class="ev.type==='deadline'?'fa-flag-checkered':'fa-map-marker-alt'"></i> {{ ev.title }}</div><div v-if="day.events.length > 3" class="text-[8px] text-slate-400 text-center font-bold">+{{ day.events.length - 3 }} more</div></div></div></div></div>
                                </div>
                                <div v-if="calendarSideEvent" class="w-80 bg-white flex flex-col border-l border-slate-200 shadow-xl z-20 fade-in relative">
                                    <button @click="calendarSideEvent=null" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
                                    <div class="p-6 border-b border-slate-100"><div class="text-xs font-bold text-slate-400 uppercase mb-1">{{ calendarSideEvent.type === 'deadline' ? 'å°ˆæ¡ˆæˆªæ­¢' : 'é‡Œç¨‹ç¢‘ç¯€é»' }}</div><h3 class="text-xl font-bold text-slate-800 leading-tight">{{ calendarSideEvent.title }}</h3></div>
                                    <div class="p-6 space-y-4 flex-1 overflow-y-auto">
                                        <div><div class="text-xs text-slate-400 font-bold mb-1">æ‰€å±¬å°ˆæ¡ˆ</div><div class="text-sm font-bold text-indigo-600">{{ calendarSideEvent.sub.title }}</div><div class="text-xs text-slate-500">{{ calendarSideEvent.parent.title }}</div></div>
                                        <div><div class="text-xs text-slate-400 font-bold mb-1">è² è²¬äºº</div><div class="flex items-center"><div class="w-6 h-6 rounded bg-slate-100 flex items-center justify-center text-xs mr-2">{{ calendarSideEvent.sub.assignee.substring(0,1) }}</div>{{ calendarSideEvent.sub.assignee }}</div></div>
                                        <div><div class="text-xs text-slate-400 font-bold mb-1">ç›®å‰ç‹€æ…‹</div><span :class="['px-2 py-1 rounded text-xs font-bold', statusBadge(calendarSideEvent.sub.status)]">{{ statusMap[calendarSideEvent.sub.status] }}</span></div>
                                        <div v-if="getProjectHealth(calendarSideEvent.sub).type !== 'normal'" class="bg-red-50 p-3 rounded border border-red-100"><div class="text-xs font-bold text-red-600 mb-1">ç•°å¸¸è­¦ç¤º</div><div class="text-sm text-red-700 font-bold">{{ getProjectHealth(calendarSideEvent.sub).type === 'delay' ? 'å·²å»¶èª¤' : 'é€²åº¦è½å¾Œ' }} {{ getProjectHealth(calendarSideEvent.sub).days }} å¤©</div></div>
                                    </div>
                                    <div class="p-4 border-t border-slate-100 bg-slate-50"><button @click="selectSubProject(calendarSideEvent.sub, calendarSideEvent.parent)" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-lg font-bold text-sm shadow">æŸ¥çœ‹å®Œæ•´è©³æƒ…</button></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-if="currentView === 'parent_detail'" class="flex-1 flex flex-col bg-white overflow-hidden w-full fade-in">
                        
                        <div class="bg-white border-b border-slate-200 px-8 py-6 shadow-sm z-10 flex flex-col md:flex-row md:items-start md:justify-between gap-4">
                            <div class="flex-1">
                                <div class="flex items-center text-xs text-slate-500 mb-2 hover:text-indigo-600 cursor-pointer transition w-fit group" @click="goBack">
                                    <i class="fas fa-arrow-left mr-2 group-hover:-translate-x-1 transition-transform"></i> è¿”å›ä¸Šä¸€é 
                                </div>
                                <h2 class="text-3xl font-bold text-slate-900 tracking-tight leading-tight">
                                    {{ currentParentProject.title }}
                                    <span v-if="currentParentProject.status==='aborted'" class="ml-2 bg-slate-200 text-slate-600 text-sm px-2 py-0.5 rounded align-middle font-medium">å·²ä¸­æ­¢</span>
                                    <span v-if="currentParentProject.status==='completed'" class="ml-2 bg-emerald-100 text-emerald-700 text-sm px-2 py-0.5 rounded align-middle font-medium">å·²æ­¸æª”</span>
                                </h2>
                                <div class="mt-2 flex items-center gap-4 text-sm text-slate-500">
                                    <span class="bg-slate-100 px-2 py-0.5 rounded font-mono text-xs border border-slate-200">ID: {{ currentParentProject.id.substring(0,8) }}</span>
                                    <span class="flex items-center"><i class="far fa-calendar-alt mr-1.5"></i> {{ currentParentProject.startDate }} ~ {{ currentParentProject.endDate }}</span>
                                    <span class="flex items-center"><i class="far fa-user-circle mr-1.5"></i> {{ currentParentProject.owner }}</span>
                                </div>
                            </div>
                            <div class="flex flex-wrap gap-2 items-start justify-end">
                                <button v-if="(currentUser.role==='director' || currentUser.name===currentParentProject.owner) && currentParentProject.status==='active'" @click="openParentAbortModal" class="bg-slate-100 hover:bg-slate-200 text-slate-600 border border-slate-300 px-4 py-2 rounded-lg font-bold text-sm transition flex items-center"><i class="fas fa-ban mr-2"></i> ä¸­æ­¢å…¨æ¡ˆ</button>
                                <button v-if="(currentUser.role==='director' || currentUser.name===currentParentProject.owner) && currentParentProject.status==='active'" @click="completeParentProject(currentParentProject)" class="bg-white hover:bg-emerald-50 text-emerald-600 border border-emerald-200 px-4 py-2 rounded-lg font-bold text-sm transition flex items-center shadow-sm"><i class="fas fa-check-circle mr-2"></i> å…¨æ¡ˆæ­¸æª”</button>
                                <button v-if="currentParentProject.status==='active'" @click="openSubProjectModal(currentParentProject.id)" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-md transition flex items-center"><i class="fas fa-plus mr-2"></i> é–‹ç«‹å­å°ˆæ¡ˆ</button>
                            </div>
                        </div>

                        <div class="flex mt-0 bg-white border-b border-slate-200 px-8">
                            <button @click="detailTab = 'overview'" :class="['px-4 py-3 text-sm font-bold border-b-2 transition -mb-[2px]', detailTab==='overview'?'border-indigo-600 text-indigo-600':'border-transparent text-slate-500 hover:text-slate-800 hover:border-slate-300']">å°ˆæ¡ˆç¸½è¦½</button>
                            <button @click="detailTab = 'gantt'" :class="['px-4 py-3 text-sm font-bold border-b-2 transition -mb-[2px]', detailTab==='gantt'?'border-indigo-600 text-indigo-600':'border-transparent text-slate-500 hover:text-slate-800 hover:border-slate-300']">ç”˜ç‰¹åœ– (Gantt)</button>
                        </div>
                    
                        <div class="flex-1 overflow-y-auto p-8 bg-slate-50/50 w-full">
                            <div v-if="detailTab === 'overview'">
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10 w-full"><div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200"><span class="text-xs font-bold text-slate-400">ç¸½å¯¦éš›å·¥æ™‚</span><div class="mt-2 text-3xl font-bold text-blue-600">{{ currentProjectStats.act || 0 }} <span class="text-sm font-medium text-slate-400">hours</span></div></div><div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200"><span class="text-xs font-bold text-slate-400">ç¸½é€²åº¦</span><div class="mt-2 text-3xl font-bold text-indigo-600">{{ currentProjectStats.progress || 0 }}%</div><div class="w-full bg-slate-100 rounded-full h-1.5 mt-2"><div class="bg-indigo-500 h-1.5 rounded-full" :style="{width: (currentProjectStats.progress||0)+'%'}"></div></div></div><div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200"><span class="text-xs font-bold text-slate-400">å‰©é¤˜å¤©æ•¸ / å»¶èª¤</span><div class="mt-2 text-3xl font-bold" :class="getDeadlineStatus(currentParentProject.endDate).status==='overdue'?'text-red-600':'text-slate-800'">{{ getDeadlineStatus(currentParentProject.endDate).label }}</div></div><div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200"><span class="text-xs font-bold text-slate-400">å®Œæˆ/ç¸½æ•¸</span><div class="mt-2 text-3xl font-bold text-slate-800">{{ currentProjectStats.completed || 0 }} <span class="text-slate-300">/</span> {{ currentProjectStats.total || 0 }}</div></div></div>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 w-full">
                                    <div v-if="getSortedSubs(currentParentProject.id).length === 0" class="text-center w-full col-span-full py-10 text-slate-400 italic border-2 border-dashed border-slate-200 rounded-lg">å°šç„¡å­å°ˆæ¡ˆ</div>
                                    <div v-for="branch in getSortedSubs(currentParentProject.id)" :key="branch.id" @click="selectSubProject(branch, currentParentProject)" class="bg-white rounded-xl p-5 cursor-pointer shadow-sm hover:shadow-md transition border border-slate-200 hover:-translate-y-1 relative" :class="branch.status==='aborted'?'opacity-60':(getProjectHealth(branch).type==='delay'?'border-red-300 ring-1 ring-red-100':'')"><div class="flex justify-between items-start mb-4"><div><h3 class="font-bold text-lg text-slate-800 group-hover:text-indigo-600">{{ branch.title }}</h3><div class="text-xs text-slate-500 mt-1 flex gap-2"><span>ğŸ‘¤ è² è²¬: {{ branch.assignee }}</span><span>âš¡ åŸ·è¡Œ: {{ branch.currentHandler }}</span></div></div><span :class="['px-2 py-1 rounded text-[10px] font-bold uppercase h-fit', statusBadge(branch.status)]">{{ statusMap[branch.status] }}</span></div><div class="mt-4 pt-4 border-t border-slate-100"><div class="flex justify-between text-xs text-slate-500 mb-2"><span :class="getDateStyle(branch.endDate)">{{ branch.endDate }} <span v-if="getSubProjectDelayDays(branch) > 0" class="ml-1 bg-red-100 text-red-600 px-1 rounded font-bold">å»¶ {{ getSubProjectDelayDays(branch) }} å¤©</span></span><span class="font-bold text-blue-600">{{ calcSubProjectHours(branch) }}h</span></div><div class="w-full bg-slate-100 rounded-full h-1.5"><div class="bg-emerald-500 h-1.5 rounded-full" :style="{width: getBranchProgress(branch).percent+'%'}"></div></div></div><div v-if="branch.delayReason" class="mt-2 bg-red-50 p-2 rounded text-[10px] text-red-600 font-bold border border-red-100"><i class="fas fa-exclamation-circle mr-1"></i> åŸå› : {{ branch.delayReason }}</div><div v-if="branch.status==='aborted'" class="absolute top-0 right-0 bg-slate-600 text-white text-[10px] px-2 py-1 rounded-bl-lg font-bold shadow-sm">ä¸­æ­¢</div><div v-else-if="getProjectHealth(branch).type === 'delay'" class="absolute top-0 right-0 bg-red-500 text-white text-[10px] px-2 py-1 rounded-bl-lg font-bold shadow-sm">å»¶é² {{ getProjectHealth(branch).days }} å¤©</div><div v-else-if="getProjectHealth(branch).type === 'lag'" class="absolute top-0 right-0 bg-orange-400 text-white text-[10px] px-2 py-1 rounded-bl-lg font-bold shadow-sm">è½å¾Œ {{ getProjectHealth(branch).days }} å¤©</div></div>
                                </div>
                            </div>
                            
                            <div v-if="detailTab === 'gantt'" class="bg-white p-0 rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-[600px]">
                                <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                                    <h3 class="font-bold text-slate-700">å°ˆæ¡ˆæ’ç¨‹ç¸½è¦½ (å¯å·¦å³æ‹–æ›³)</h3>
                                    <div class="flex items-center gap-2">
                                        <button @click="changeGanttZoom(-10)" class="w-8 h-8 rounded bg-white border border-slate-300 hover:bg-slate-50 flex items-center justify-center text-slate-500"><i class="fas fa-search-minus"></i></button>
                                        <button @click="changeGanttZoom(10)" class="w-8 h-8 rounded bg-white border border-slate-300 hover:bg-slate-50 flex items-center justify-center text-slate-500"><i class="fas fa-search-plus"></i></button>
                                    </div>
                                </div>
                                <div class="flex-1 overflow-hidden relative">
                                    <div ref="ganttContainer" class="gantt-scroll-container h-full w-full" @mousedown="startDrag" @mousemove="doDrag" @mouseup="stopDrag" @mouseleave="stopDrag">
                                        <div class="gantt-header-row" :style="{ width: (220 + getGanttDays(currentParentProject).length * ganttCellWidth) + 'px' }">
                                            <div class="gantt-label-col">å­å°ˆæ¡ˆåç¨±</div>
                                            <div v-for="day in getGanttDays(currentParentProject)" :key="day.iso" :style="{ width: ganttCellWidth + 'px' }" :class="['gantt-day-cell', day.isWeekend ? 'weekend' : '']">{{ day.label }}</div>
                                        </div>
                                        <div v-for="sp in getSubsForParent(currentParentProject.id)" :key="sp.id" class="gantt-row" :style="{ width: (220 + getGanttDays(currentParentProject).length * ganttCellWidth) + 'px' }">
                                            <div class="gantt-label-col truncate" :title="sp.title">{{ sp.title }}</div>
                                            <div class="gantt-timeline-area flex-1">
                                                 <div v-for="day in getGanttDays(currentParentProject)" :key="'bg'+day.iso" :style="{ width: ganttCellWidth + 'px' }" :class="['gantt-day-cell', day.isWeekend ? 'weekend' : '']"></div>
                                                 <div :class="['gantt-bar', getProjectHealth(sp).type==='delay'?'bg-red-500':(sp.status==='completed'?'bg-emerald-500':'bg-indigo-500')]" :style="getDynamicGanttBarStyles(sp, currentParentProject)">{{ sp.title }}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div v-if="currentView === 'sub_project_detail'" class="flex-1 flex flex-col h-full bg-white w-full fade-in"><div class="border-b border-slate-200 px-8 py-6 bg-white w-full shadow-sm z-10"><div class="flex items-center gap-2 mb-4 bg-slate-50 p-2 rounded-lg border border-slate-100" v-if="currentSubProject.links && currentSubProject.links.length > 0"><span class="text-[10px] font-bold text-slate-400 uppercase mr-2">è³‡æºé€£çµ:</span><a v-for="l in currentSubProject.links" :key="l.url" :href="l.url" target="_blank" class="flex items-center text-xs text-indigo-600 hover:text-indigo-800 bg-white px-2 py-1 rounded border border-indigo-100 hover:border-indigo-300 transition"><i class="fas fa-link mr-1"></i> {{ l.title }}</a></div><div class="flex items-center justify-between mb-3"><div class="flex items-center text-xs text-slate-500 hover:text-indigo-600 cursor-pointer transition w-fit" @click="goBack"><i class="fas fa-arrow-left mr-2"></i> è¿”å›ä¸Šä¸€é </div><div class="flex items-center gap-2"><span v-if="currentSubProject.status === 'setup'" class="bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full text-xs font-bold animate-pulse">è¦åŠƒä¸­ (Setup)</span><span v-if="currentSubProject.status === 'in_progress'" class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-xs font-bold">åŸ·è¡Œä¸­</span><span v-if="currentSubProject.status === 'completed'" class="bg-emerald-100 text-emerald-700 px-3 py-1 rounded-full text-xs font-bold">å·²çµæ¡ˆ</span><span v-if="currentSubProject.status === 'aborted'" class="bg-slate-600 text-white px-3 py-1 rounded-full text-xs font-bold">å·²ä¸­æ­¢</span><span v-if="getProjectHealth(currentSubProject).type === 'delay'" class="bg-red-100 text-red-600 px-3 py-1 rounded-full text-xs font-bold border border-red-200"><i class="fas fa-clock mr-1"></i> å»¶èª¤ {{ getProjectHealth(currentSubProject).days }} å¤©</span></div></div><div class="flex justify-between items-start"><div><h2 class="text-2xl font-bold text-slate-800 mb-2 flex items-center">{{ currentSubProject.title }} <button v-if="canEditSubProject" @click="addResourceLink" class="ml-3 text-xs bg-slate-100 text-slate-500 w-6 h-6 rounded-full hover:bg-indigo-50 hover:text-indigo-600 transition" title="æ–°å¢é€£çµ"><i class="fas fa-plus"></i></button></h2><div class="flex items-center space-x-6 text-sm text-slate-600"><div class="flex items-center bg-slate-100 px-3 py-1.5 rounded-lg border border-slate-200"><span class="text-xs font-bold text-slate-400 mr-2 uppercase">è² è²¬äºº</span><i class="fas fa-user-circle mr-1 text-slate-500"></i> <span class="font-bold text-slate-700">{{ currentSubProject.assignee }}</span></div><div class="flex items-center bg-indigo-50 px-3 py-1.5 rounded-lg border border-indigo-100"><span class="text-xs font-bold text-indigo-400 mr-2 uppercase">ç›®å‰è™•ç†</span><i class="fas fa-hand-holding mr-1 text-indigo-500"></i> <span class="font-bold text-indigo-700">{{ currentSubProject.currentHandler || currentSubProject.assignee }}</span></div></div><div class="text-xs text-slate-400 mt-2">èµ·è¿„: {{ currentSubProject.startDate || 'æœªå®š' }} ~ {{ currentSubProject.endDate || 'æœªå®š' }}</div></div><div class="text-right"><div class="text-3xl font-bold text-blue-600">{{ calcSubProjectHours(currentSubProject) }} <span class="text-sm text-slate-400 font-medium">hours</span></div><div class="flex gap-2 mt-2 justify-end" v-if="canEditSubProject && (currentSubProject.status === 'in_progress' || currentSubProject.status === 'setup')"><button v-if="currentSubProject.status === 'in_progress'" @click="openEditBranchModal" class="text-xs bg-slate-100 hover:bg-slate-200 text-slate-600 px-3 py-1.5 rounded font-bold transition flex items-center"><i class="fas fa-cog mr-1"></i> è¨­å®š</button>
                        <button v-if="currentSubProject.status === 'in_progress'" @click="openSubAbortModal" class="text-xs bg-slate-500 hover:bg-slate-600 text-white px-3 py-1.5 rounded transition">â›” ä¸­æ­¢å°ˆæ¡ˆ</button>
                      <!--  <button v-if="currentSubProject.status === 'in_progress'" @click="tryCompleteSubProject" class="text-xs bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-1.5 rounded transition">å®Œæˆå°ˆæ¡ˆ</button>
                   -->
                    </div>
                </div>
                <div v-if="currentSubProject.delayReason" class="mt-4 bg-red-50 border-l-4 border-red-500 p-4 rounded-r-lg">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-exclamation-triangle text-red-500"></i>
                        </div><div class="ml-3"><h3 class="text-sm font-bold text-red-800">å»¶é²çµæ¡ˆåŸå› ï¼š{{ currentSubProject.delayReason }}</h3><div class="mt-1 text-sm text-red-700">{{ currentSubProject.delayRemark }}</div></div></div></div></div><div class="flex mt-6 space-x-1 border-b border-slate-200"><button @click="detailTab = 'events'" :class="['px-4 py-2 text-sm font-bold border-b-2 transition', detailTab==='events'?'border-indigo-600 text-indigo-600':'border-transparent text-slate-400 hover:text-slate-600']">å·¥ä½œæ—¥èªŒ</button><button @click="detailTab = 'comments'" :class="['px-4 py-2 text-sm font-bold border-b-2 transition', detailTab==='comments'?'border-indigo-600 text-indigo-600':'border-transparent text-slate-400 hover:text-slate-600']">ç•™è¨€è¨è«– ({{ currentSubProject.comments?.length || 0 }})</button></div></div><div class="flex-1 overflow-y-auto p-8 w-full bg-slate-50/50"><div class="w-full max-w-5xl mx-auto"><div v-if="currentSubProject.status === 'setup'"><template v-if="currentSubProject.assignee === currentUser.name"><div class="bg-white p-8 rounded-xl shadow-lg border border-indigo-100 mb-8"><h3 class="font-bold text-lg text-slate-800 mb-4 border-b pb-2">Step 1: å°ˆæ¡ˆè¦åŠƒèˆ‡é‡Œç¨‹ç¢‘è¨­å®š</h3><div class="grid grid-cols-2 gap-6 mb-6"><div><label class="block text-xs font-bold text-slate-500 mb-1">å­å°ˆæ¡ˆé–‹å§‹æ—¥ (Default: Today)</label><input type="date" v-model="setupForm.startDate" class="w-full border rounded-lg px-3 py-2"></div><div><label class="block text-xs font-bold text-slate-500 mb-1">å­å°ˆæ¡ˆçµæŸæ—¥</label><input type="date" v-model="setupForm.endDate" class="w-full border rounded-lg px-3 py-2 disabled:bg-slate-50 disabled:text-slate-400 cursor-not-allowed" disabled></div></div><div class="mb-6"><div class="flex justify-between items-center mb-2"><label class="block text-xs font-bold text-slate-500">é‡Œç¨‹ç¢‘ (Milestones)</label><button @click="addSetupMilestone" class="text-xs bg-slate-100 hover:bg-slate-200 px-2 py-1 rounded">+ æ–°å¢ç¯€é»</button></div><div v-for="(m, idx) in setupForm.milestones" :key="idx" class="flex gap-2 mb-2"><input type="date" v-model="m.date" class="border rounded px-2 py-1 text-sm"><input v-model="m.title" placeholder="ç¯€é»æ¨™é¡Œ" class="flex-1 border rounded px-2 py-1 text-sm"><button @click="setupForm.milestones.splice(idx,1)" class="text-red-400 hover:text-red-600"><i class="fas fa-times"></i></button></div></div><div class="text-right"><button @click="confirmSetup" :disabled="isSubmitting" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-bold shadow hover:bg-indigo-700 disabled:opacity-50">ç¢ºèªè¦åŠƒä¸¦é–‹æ¡ˆ</button></div></div></template><div v-else class="text-center py-12 bg-white rounded-xl shadow-sm border border-slate-200"><i class="fas fa-user-lock text-4xl text-slate-300 mb-4"></i><h3 class="text-lg font-bold text-slate-600">ç­‰å¾…è² è²¬äººè¦åŠƒ</h3><p class="text-slate-400 text-xs mt-2">æ­¤å°ˆæ¡ˆéœ€ç”± <span class="font-bold text-indigo-500">{{ currentSubProject.assignee }}</span> è¨­å®šé‡Œç¨‹ç¢‘å¾Œæ–¹å¯åŸ·è¡Œã€‚</p></div></div><div v-else><div class="mb-8"><h3 class="font-bold text-slate-700 mb-4 text-sm uppercase tracking-wide">é å®šé‡Œç¨‹ç¢‘</h3><div class="relative pl-6 space-y-0"><div v-if="sortedMilestones.length===0" class="text-slate-400 text-sm italic">ç„¡è¨­å®šé‡Œç¨‹ç¢‘</div><div v-for="(ms, index) in sortedMilestones" :key="ms.id" class="relative pl-10 pb-8 group" :class="{'last-node': index === sortedMilestones.length - 1}"><div class="node-line"></div><div class="absolute left-0 top-1 w-8 h-8 rounded-full border-4 shadow-sm flex items-center justify-center bg-white" :class="ms.isCompleted ? 'border-emerald-500 text-emerald-500' : (isMilestoneOverdue(ms) ? 'border-orange-400 text-orange-500' : 'border-slate-300 text-slate-300')"><i v-if="ms.isCompleted" class="fas fa-check text-xs"></i><i v-else-if="isMilestoneOverdue(ms)" class="fas fa-exclamation text-xs"></i><div v-else class="w-2 h-2 rounded-full bg-current"></div></div><div class="bg-white border rounded-lg p-4 shadow-sm flex justify-between items-center" :class="ms.isCompleted ? 'border-emerald-200 bg-emerald-50/30' : 'border-slate-200'"><div><div class="font-bold text-slate-800" :class="ms.isCompleted?'line-through text-slate-400':''">{{ ms.title }}</div><div class="text-xs text-slate-500 mt-1 flex items-center"><i class="far fa-calendar-alt mr-1"></i> {{ ms.date }} <span v-if="ms.isCompleted" class="ml-2 text-emerald-600 font-bold">(å®Œæˆæ–¼ {{ ms.completedDate }})</span><span v-else-if="isMilestoneOverdue(ms)" class="ml-2 text-orange-500 font-bold">å·²è½å¾Œ {{ getDaysLate(ms.date) }} å¤© (è­¦ç¤º)</span></div></div><div v-if="ms.isCompleted"><span v-if="ms.diffDays < 0" class="text-xs bg-emerald-100 text-emerald-700 px-2 py-1 rounded font-bold">ææ—© {{ Math.abs(ms.diffDays) }} å¤©</span><span v-else-if="ms.diffDays > 0" class="text-xs bg-red-100 text-red-700 px-2 py-1 rounded font-bold">å»¶é² {{ ms.diffDays }} å¤©</span><span v-else class="text-xs bg-slate-100 text-slate-600 px-2 py-1 rounded font-bold">æº–æ™‚å®Œæˆ</span></div></div></div></div></div><div v-if="detailTab === 'events'" class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden"><div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center"><h3 class="font-bold text-slate-700">å·¥ä½œæ—¥èªŒèˆ‡å“é… (Events)</h3><button v-if="currentSubProject.status === 'in_progress' && canEditSubProject" @click="openEventModal" class="text-xs bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded shadow flex items-center"><i class="fas fa-pen mr-2"></i> æ–°å¢å·¥ä½œæ—¥èªŒ / äº¤æ¥</button></div><div class="p-0"><table class="w-full text-sm text-left"><thead class="text-xs text-slate-500 uppercase bg-slate-50 border-b"><tr><th class="px-6 py-3">æ—¥æœŸ</th><th class="px-6 py-3">åŸ·è¡Œäººå“¡</th><th class="px-6 py-3">å…§å®¹</th><th class="px-6 py-3 text-center">å·¥æ™‚</th><th class="px-6 py-3">åŒ¹é…ç¯€é»</th></tr></thead><tbody class="divide-y divide-slate-100"><tr v-if="!currentSubProject.events || currentSubProject.events.length===0"><td colspan="5" class="px-6 py-8 text-center text-slate-400 italic">å°šç„¡å·¥ä½œè¨˜éŒ„</td></tr><tr v-for="ev in (currentSubProject.events || [])" :key="ev.id"><td class="px-6 py-3 font-mono text-slate-600">{{ ev.date }}</td><td class="px-6 py-3"><div class="flex items-center gap-2"><div class="w-5 h-5 rounded bg-slate-200 flex items-center justify-center text-[10px]">{{ ev.worker.substring(0,1) }}</div>{{ ev.worker }}</div></td><td class="px-6 py-3 text-slate-700">{{ ev.description }}<div v-if="ev.handoffTo" class="mt-1 text-xs text-indigo-600 font-bold"><i class="fas fa-arrow-right mr-1"></i> äº¤æ¥çµ¦ï¼š{{ ev.handoffTo }}</div></td><td class="px-6 py-3 text-center font-bold text-blue-600">{{ ev.hours }} h</td><td class="px-6 py-3"><span v-if="ev.matchedMilestoneId" class="inline-flex items-center px-2 py-0.5 rounded text-[10px] bg-emerald-100 text-emerald-700 border border-emerald-200"><i class="fas fa-link mr-1"></i> {{ getMilestoneName(ev.matchedMilestoneId) }}</span><span v-else class="text-slate-300 text-xs">-</span></td></tr></tbody></table></div></div><div v-if="detailTab === 'comments'" class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-96"><div class="flex-1 overflow-y-auto p-6 space-y-4 bg-slate-50"><div v-if="!currentSubProject.comments || currentSubProject.comments.length===0" class="text-center text-slate-400 text-xs italic py-10">å°šç„¡ç•™è¨€ï¼Œé–‹å§‹è¨è«–å§ï¼</div><div v-for="c in currentSubProject.comments" :key="c.id" :class="['flex', c.user === currentUser.name ? 'justify-end' : 'justify-start']"><div :class="['max-w-[70%] rounded-lg p-3 text-sm shadow-sm relative', c.user === currentUser.name ? 'bg-indigo-600 text-white chat-right' : 'bg-white border border-slate-200 text-slate-700 chat-left']"><div class="text-[10px] opacity-70 mb-1 flex justify-between gap-4"><span>{{ c.user }}</span><span>{{ c.time }}</span></div>{{ c.content }}</div></div></div><div class="p-4 bg-white border-t border-slate-100 flex gap-2 relative"><input v-model="newComment" @keyup.enter="addComment" @input="checkForMention" type="text" class="flex-1 border rounded-lg px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500" placeholder="è¼¸å…¥ç•™è¨€... (@æåŠæˆå“¡)"><div v-if="showMentionList" class="absolute bottom-16 left-4 bg-white shadow-xl rounded-lg border w-48 z-50 overflow-hidden"><div v-for="u in users" :key="u.id" @click="selectMention(u.name)" class="px-3 py-2 text-xs hover:bg-indigo-50 cursor-pointer font-bold text-slate-700">{{ u.name }}</div></div><button @click="addComment" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-indigo-700"><i class="fas fa-paper-plane"></i></button></div></div></div></div></div>

            </div>

            <div v-if="showMemberDetailModal" class="fixed inset-0 z-[9999] bg-slate-900/50 backdrop-blur-sm flex items-center justify-center fade-in"><div class="bg-white w-[900px] h-[90vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden"><div class="px-8 py-6 border-b flex justify-between items-center bg-slate-50"><div><h3 class="font-bold text-2xl text-slate-800 flex items-center"><div class="w-10 h-10 rounded-full bg-indigo-600 text-white flex items-center justify-center text-lg mr-3">{{ currentMemberDetail.name.substring(0,1) }}</div>{{ currentMemberDetail.name }} <span class="text-sm font-normal text-slate-500 ml-2">({{ teamMap[currentMemberDetail.team] }} â€¢ {{ roleMap[currentMemberDetail.role] }})</span></h3></div><div class="flex items-center gap-3"><span class="text-xs font-bold text-slate-400">å¹´ä»½ç¯©é¸:</span><select v-model="memberDetailYear" @change="recalcMemberDetail" class="border border-slate-300 rounded px-2 py-1 text-sm"><option value="all">å…¨éƒ¨</option><option v-for="y in [2023,2024,2025,2026]" :value="y">{{ y }}å¹´</option></select><button @click="showMemberDetailModal=false" class="text-slate-400 hover:text-slate-600 ml-2"><i class="fas fa-times text-xl"></i></button></div></div><div class="flex-1 overflow-y-auto p-8 bg-slate-50/50"><div class="grid grid-cols-1 md:grid-cols-2 gap-8 h-full"><div class="space-y-6 flex flex-col h-full"><div class="bg-white rounded-xl border border-slate-200 overflow-hidden flex-1 flex flex-col"><div class="px-4 py-3 bg-red-50 border-b border-red-100 text-xs font-bold text-red-800 flex justify-between"><span>ğŸ”´ æ‰‹ä¸Šå¾…è¾¦æ¸…å–® (Handling)</span><span>{{ memberDetailData.active.count }} æ¡ˆ</span></div><div class="flex-1 overflow-y-auto"><div v-if="memberDetailData.active.tasks.length===0" class="p-4 text-center text-slate-400 text-xs">ç›®å‰ç„¡å¾…è¾¦</div><div v-for="t in memberDetailData.active.tasks" :key="t.sub.id" class="p-3 border-b last:border-0 hover:bg-slate-50 flex justify-between items-center"><div class="truncate pr-2"><div class="text-[10px] text-slate-400">{{ t.parent.title }}</div><div class="font-bold text-sm text-slate-700 truncate">{{ t.sub.title }}</div></div><div class="text-right flex flex-col items-end"><span class="text-xs font-bold text-indigo-600">{{ t.holdDays }} å¤©</span><span class="text-[10px] text-slate-400">æ»¯ç•™</span></div></div></div></div><div class="bg-white rounded-xl border border-slate-200 overflow-hidden flex-1 flex flex-col"><div class="px-4 py-3 bg-indigo-50 border-b border-indigo-100 text-xs font-bold text-indigo-800 flex justify-between"><span>ğŸ”µ è² è²¬å°ˆæ¡ˆåˆ—è¡¨ (Owned) <span v-if="memberDetailYear!=='all'">({{ memberDetailYear }})</span></span><span>{{ memberDetailData.overall.total }} æ¡ˆ</span></div><div class="flex-1 overflow-y-auto"><div v-if="memberDetailData.overall.projects.length===0" class="p-4 text-center text-slate-400 text-xs">ç„¡è² è²¬å°ˆæ¡ˆ</div><div v-for="p in memberDetailData.overall.projects" :key="p.sub.id" class="p-3 border-b last:border-0 hover:bg-slate-50 flex justify-between items-center text-xs"><div class="truncate pr-2 font-bold text-slate-700">{{ p.sub.title }}</div><div><span :class="statusBadge(p.sub.status)" class="px-1.5 py-0.5 rounded text-[10px]">{{ statusMap[p.sub.status] }}</span></div></div></div></div></div><div class="space-y-6"><div><h4 class="font-bold text-lg text-slate-700 mb-3">åŸ·è¡Œé¢¨éšªæŒ‡æ¨™</h4><div class="grid grid-cols-2 gap-4"><div class="bg-white p-5 rounded-xl border border-red-100 shadow-sm"><div class="text-xs text-slate-500 mb-1">å¹³å‡æ»¯ç•™</div><div class="text-3xl font-bold text-red-600">{{ memberDetailData.active.avgHoldDays }} <span class="text-sm font-normal text-slate-400">å¤©</span></div></div><div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm"><div class="text-xs text-slate-500 mb-1">æœ€å¤§æ»¯ç•™</div><div class="text-3xl font-bold text-slate-800">{{ memberDetailData.active.maxHold || 0 }} <span class="text-sm font-normal text-slate-400">å¤©</span></div></div></div></div><div><h4 class="font-bold text-lg text-slate-700 mb-3">æ­·å²ç¸¾æ•ˆæŒ‡æ¨™ <span v-if="memberDetailYear!=='all'" class="text-xs bg-slate-200 px-2 py-0.5 rounded">{{ memberDetailYear }}</span></h4><div class="grid grid-cols-2 gap-4"><div class="bg-white p-4 rounded-xl border border-indigo-100 shadow-sm"><div class="text-xs text-slate-500 mb-1">å»¶é²ç‡</div><div class="text-2xl font-bold text-indigo-600">{{ memberDetailData.overall.delayRate }}%</div></div><div class="bg-white p-4 rounded-xl border border-indigo-100 shadow-sm"><div class="text-xs text-slate-500 mb-1">ç¸½å»¶é²å¤©æ•¸</div><div class="text-2xl font-bold text-pink-600">{{ memberDetailData.overall.totalDelayDays }} <span class="text-xs text-slate-400">å¤©</span></div></div></div></div><div class="bg-white rounded-xl border border-slate-200 overflow-hidden"><div class="px-4 py-3 bg-slate-50 border-b text-xs font-bold text-slate-500">ä¸»è¦å»¶é²åŸå›  (Top 5)</div><div class="p-4 space-y-3"><div v-if="memberDetailData.overall.reasons.length===0" class="text-center text-slate-400 text-xs">å°šç„¡å»¶é²ç´€éŒ„</div><div v-for="r in memberDetailData.overall.reasons.slice(0,5)" :key="r.name" class="flex items-center text-sm"><span class="w-24 font-bold text-slate-600 truncate">{{ r.name }}</span><div class="flex-1 h-2 bg-slate-100 rounded-full mx-3"><div class="h-2 bg-indigo-500 rounded-full" :style="{width: r.percent+'%'}"></div></div><span class="font-bold text-indigo-600">{{ r.count }}</span></div></div></div></div></div></div></div></div>
            
            <div v-if="showEditBranchModal" class="fixed inset-0 z-[9999] bg-slate-900/50 backdrop-blur-sm flex items-center justify-center fade-in"><div class="bg-white w-[500px] rounded-2xl shadow-2xl p-8 flex flex-col max-h-[90vh]"><h3 class="font-bold text-xl text-slate-800 mb-6">ç·¨è¼¯å­å°ˆæ¡ˆè¨­å®š</h3><div class="space-y-4 flex-1 overflow-y-auto"><div><label class="text-xs font-bold text-slate-500 block mb-1">å°ˆæ¡ˆåç¨±</label><input v-model="editBranchForm.title" class="w-full border rounded-lg px-3 py-2"></div>
<div class="grid grid-cols-2 gap-4">
    <div>
        <label class="text-xs font-bold text-slate-500 block mb-1">é–‹å§‹æ—¥ (ä¸å¯è®Šæ›´)</label>
        <input type="date" v-model="editBranchForm.startDate" class="w-full border rounded-lg px-3 py-2 bg-slate-100 text-slate-500 cursor-not-allowed" disabled>
    </div>
    <div>
        <label class="text-xs font-bold text-slate-500 block mb-1">çµæŸæ—¥ (ç”±é‡Œç¨‹ç¢‘æ±ºå®š)</label>
        <input type="date" v-model="editBranchForm.endDate" class="w-full border rounded-lg px-3 py-2 bg-slate-100 text-slate-500 cursor-not-allowed" disabled>
    </div>
</div>
            <div><label class="text-xs font-bold text-slate-500 block mb-1">ç›®å‰è² è²¬äºº (Assignee)</label><select v-model="editBranchForm.assignee" class="w-full border rounded-lg px-3 py-2"><option v-for="u in users" :value="u.name">{{ u.name }}</option></select></div>
            <div class="border-t pt-4 mt-4 bg-orange-50 p-3 rounded border-orange-100">
                <label class="text-xs font-bold text-orange-700 block mb-1">å»¶é²åŸå› æ¨™è¨˜ (åŸ·è¡Œä¸­å¯å¡«)</label>
                <select v-model="editBranchForm.delayReason" class="w-full border border-orange-200 rounded-lg px-3 py-2 text-sm bg-white">
                    <option value="">-- ç„¡ --</option>
                    <option value="äººåŠ›ä¸è¶³">äººåŠ›ä¸è¶³</option>
                    <option value="å®¢æˆ¶ç«¯å»¶é²">å®¢æˆ¶ç«¯å»¶é²</option>
                    <option value="éœ€æ±‚è®Šæ›´">éœ€æ±‚è®Šæ›´</option>
                    <option value="æŠ€è¡“ç“¶é ¸">æŠ€è¡“ç“¶é ¸</option>
                    <option value="å» å•†å› ç´ ">å» å•†å› ç´ </option>
                    <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
            </div>
        </div><div class="flex justify-end space-x-3 pt-6 border-t mt-4"><button @click="showEditBranchModal=false" class="px-4 text-slate-500">å–æ¶ˆ</button><button @click="saveEditedBranch" :disabled="isSubmitting" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-bold disabled:opacity-50">å„²å­˜è®Šæ›´</button></div></div></div>
            
            <div v-if="showProjectModal" class="fixed inset-0 z-[9999] bg-slate-900/50 backdrop-blur-sm flex items-center justify-center fade-in"><div class="bg-white w-[500px] rounded-2xl shadow-2xl flex flex-col p-8 space-y-5"><h3 class="font-bold text-xl text-slate-800">é–‹ç«‹å°ˆæ¡ˆ (Parent)</h3><div class="space-y-4"><div><label class="block text-xs font-bold text-slate-500 mb-1">å°ˆæ¡ˆåç¨±</label><input v-model="projectForm.title" class="w-full border rounded-lg px-4 py-2"></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-xs font-bold text-slate-500 mb-1">é–‹æ¡ˆæ—¥</label><input type="date" v-model="projectForm.startDate" class="w-full border rounded-lg px-4 py-2"></div><div><label class="block text-xs font-bold text-slate-500 mb-1">é è¨ˆçµæŸ</label><input type="date" v-model="projectForm.endDate" class="w-full border rounded-lg px-4 py-2"></div></div></div><div class="flex justify-end space-x-3 pt-4"><button @click="showProjectModal=false" class="px-4 text-slate-500">å–æ¶ˆ</button><button @click="saveProject" :disabled="isSubmitting" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-bold shadow-lg disabled:opacity-50">å»ºç«‹</button></div></div></div>
            
            <div v-if="showSubProjectModal" class="fixed inset-0 z-[9999] bg-slate-900/50 backdrop-blur-sm flex items-center justify-center fade-in"><div class="bg-white w-[500px] rounded-2xl shadow-2xl p-8 space-y-5"><h3 class="font-bold text-xl text-slate-800">é–‹ç«‹å­å°ˆæ¡ˆ</h3><input v-model="subProjectForm.title" class="w-full border rounded-lg px-4 py-2" placeholder="å­å°ˆæ¡ˆåç¨±"><select v-model="subProjectForm.assignee" class="w-full border rounded-lg px-4 py-2 bg-white"><option v-for="u in users" :value="u.name">{{ u.name }} ({{ teamMap[u.team] }})</option></select><div class="flex justify-end space-x-3 pt-4"><button @click="showSubProjectModal=false" class="px-4 text-slate-500">å–æ¶ˆ</button><button @click="saveSubProject" :disabled="isSubmitting" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-bold shadow-lg disabled:opacity-50">é–‹ç«‹</button></div></div></div>
            
            <div v-if="showEventModal" class="fixed inset-0 z-[9999] bg-slate-900/50 backdrop-blur-sm flex items-center justify-center fade-in"><div class="bg-white w-[500px] rounded-2xl shadow-2xl p-8 space-y-5"><h3 class="font-bold text-xl text-slate-800">æ–°å¢å·¥ä½œæ—¥èªŒ</h3><div class="grid grid-cols-2 gap-4"><div><label class="block text-xs font-bold text-slate-500 mb-1">æ—¥æœŸ</label><input type="date" v-model="eventForm.date" class="w-full border rounded-lg px-3 py-2"></div><div><label class="block text-xs font-bold text-slate-500 mb-1">å·¥æ™‚ (Hr)</label><input type="number" v-model="eventForm.hours" class="w-full border rounded-lg px-3 py-2"></div></div><div><label class="block text-xs font-bold text-slate-500 mb-1">åŸ·è¡Œäººå“¡</label><div class="w-full bg-slate-100 border rounded-lg px-3 py-2 text-slate-600 cursor-not-allowed">{{ eventForm.worker }}</div></div><div><label class="block text-xs font-bold text-slate-500 mb-1">å·¥ä½œå…§å®¹</label><textarea v-model="eventForm.description" class="w-full border rounded-lg px-3 py-2 h-20" placeholder="åšäº†ä»€éº¼..."></textarea></div><div v-if="incompleteMilestones.length > 0" class="border-t pt-4"><label class="block text-xs font-bold text-indigo-600 mb-2">åŒ¹é…ç¯€é» (é¸å¡«)</label><select v-model="eventForm.matchedMilestoneId" class="w-full border border-indigo-200 bg-indigo-50 rounded-lg px-3 py-2 text-sm text-indigo-800"><option value="">-- ç„¡åŒ¹é…ç¯€é» --</option><option v-for="ms in incompleteMilestones" :value="ms.id">{{ ms.title }} (é å®š: {{ ms.date }})</option></select></div><div class="border-t pt-4 bg-orange-50 p-3 rounded-lg border-orange-100"><label class="block text-xs font-bold text-orange-700 mb-1"><i class="fas fa-share mr-1"></i> å¾ŒçºŒè™•ç†äººå“¡ (çƒæ¬Šç§»è½‰)</label><select v-model="eventForm.nextAssignee" class="w-full border border-orange-200 rounded-lg px-3 py-2 text-sm bg-white"><option v-for="u in users" :value="u.name">{{ u.name }} {{ u.name === currentUser.name ? '(æˆ‘è‡ªå·±)' : '' }}</option></select></div><div class="flex justify-end space-x-3 pt-4"><button @click="showEventModal=false" class="px-4 text-slate-500">å–æ¶ˆ</button><button @click="saveEvent" :disabled="isSubmitting" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold shadow-lg disabled:opacity-50">å„²å­˜ä¸¦æ›´æ–°</button></div></div></div>
            
            <div v-if="showDelayReasonModal" class="fixed inset-0 z-[9999] bg-red-900/50 backdrop-blur-sm flex items-center justify-center fade-in"><div class="bg-white w-[400px] rounded-2xl shadow-2xl p-8 space-y-5 border-t-4" :class="modalMode.includes('abort')?'border-red-600':'border-orange-500'"><h3 class="font-bold text-xl" :class="modalMode.includes('abort')?'text-red-600':'text-orange-600'">{{ modalTitle }}</h3><p class="text-sm text-slate-600">è«‹å¡«å¯«åŸå› èˆ‡å‚™è¨»ä»¥å®Œæˆæ“ä½œã€‚</p>
                <select v-model="delayForm.reason" class="w-full border rounded-lg px-3 py-2">
                    <option value="äººåŠ›ä¸è¶³">äººåŠ›ä¸è¶³</option>
                    <option value="å®¢æˆ¶ç«¯å»¶é²">å®¢æˆ¶ç«¯å»¶é²</option>
                    <option value="éœ€æ±‚è®Šæ›´">éœ€æ±‚è®Šæ›´</option>
                    <option value="æŠ€è¡“ç“¶é ¸">æŠ€è¡“ç“¶é ¸</option>
                    <option value="å» å•†å› ç´ ">å» å•†å› ç´ </option>
                    <option value="ç­–ç•¥èª¿æ•´">ç­–ç•¥èª¿æ•´ (ä¸­æ­¢ç”¨)</option>
                    <option value="é ç®—å–æ¶ˆ">é ç®—å–æ¶ˆ (ä¸­æ­¢ç”¨)</option>
                    <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
                <textarea v-model="delayForm.remark" class="w-full border rounded-lg px-3 py-2 h-20" placeholder="å‚™è¨»èªªæ˜..."></textarea><div class="flex justify-end space-x-3 pt-4"><button @click="showDelayReasonModal=false" class="px-4 text-slate-500">å–æ¶ˆ</button><button @click="submitDelayModal" :disabled="isSubmitting" :class="modalMode.includes('abort')?'bg-red-600':'bg-orange-500'" class="text-white px-6 py-2 rounded-lg font-bold disabled:opacity-50">ç¢ºèª</button></div></div></div>
        </template>
    </div>
<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, updateDoc, doc, deleteDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { createApp } from "https://unpkg.com/vue@3/dist/vue.esm-browser.js";

        // --- Config ---
        const firebaseConfig = { apiKey: "AIzaSyATSEmDeRBOAmRXb-5AaqrTI9EbGgVxs0g", authDomain: "mkt-pm-system.firebaseapp.com", projectId: "mkt-pm-system", storageBucket: "mkt-pm-system.firebasestorage.app", messagingSenderId: "457242310730", appId: "1:457242310730:web:6d929af5109e62ac5eceb3" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Factory ---
        const DataFactory = {
            createProject: (input, user) => ({
                brandId: input.brandId || '',
                title: input.title ? `ã€${input.startDate || 'NoDate'}ã€‘${input.title}` : 'Untitled Project',
                startDate: input.startDate || new Date().toISOString().split('T')[0],
                endDate: input.endDate || '',
                owner: user?.name || 'Unknown',
                status: 'active',
                createdAt: new Date().toISOString()
            }),
            createSubProject: (input, user) => ({
                parentId: input.parentId || '',
                title: input.title || 'Untitled SubProject',
                assignee: input.assignee || 'Unassigned',
                currentHandler: input.assignee || 'Unassigned',
                status: 'setup',
                startDate: new Date().toISOString().split('T')[0],
                endDate: '',
                lastHandoffDate: new Date().toISOString().split('T')[0],
                milestones: [], events: [], links: [], comments: [],
                delayReason: '', delayRemark: '', finalDelayDays: 0,
                createdAt: new Date().toISOString()
            })
        };

        createApp({
            data() {
                return {
                    userParams: null, authForm: { email: '', password: '', name: '', team: 'digital', role: 'member' }, isRegisterMode: false, authError: '',
                    currentView: 'dashboard', selectedDashboardBrand: 'all', sidebarSearch: '', brandExpandedState: {}, 
                    historyStack: [],
                    currentYear: new Date().getFullYear(), currentMonth: new Date().getMonth() + 1, filterStatus: 'all',
                    users: [], currentUserId: null, brands: [], 
                    rawParents: [], rawSubs: [],
                    indexedSubsByParent: {}, indexedBrandMap: {}, indexedParentMap: {},    
                    currentParentProject: null, currentSubProject: null, calendarSideEvent: null,
                    showProjectModal: false, projectForm: {}, 
                    showSubProjectModal: false, subProjectForm: {},
                    showEditBranchModal: false, editBranchForm: {}, 
                    setupForm: { startDate: '', endDate: '', milestones: [] },
                    showEventModal: false, eventForm: {}, 
                    showDelayReasonModal: false, delayForm: {}, modalMode: 'sub_complete',
                    showArchived: false,
                    showMemberDetailModal: false, currentMemberDetail: { name: '', team: '', role: '' }, memberDetailData: { active: { tasks: [] }, overall: { projects: [], reasons: [] } },
                    showNotifications: false, notifications: [], detailTab: 'overview', newComment: '', showMentionList: false,
                    calendarYear: new Date().getFullYear(), calendarMonth: new Date().getMonth() + 1,
                    memberDetailYear: 'all', 
                    teamMap: { 'digital': 'æ•¸ä½èª²', 'design': 'è¨­è¨ˆèª²', 'mkgt': 'è¡ŒéŠ·éƒ¨', 'brand': 'å“ç‰Œèª²', 'pr': 'å…¬é—œèª²' },
                    roleMap: { 'director': 'éƒ¨ä¸»ç®¡', 'manager': 'èª²ä¸»ç®¡', 'member': 'è·å“¡' },
                    statusMap: { 'setup': 'è¦åŠƒä¸­', 'in_progress': 'åŸ·è¡Œä¸­', 'completed': 'å·²çµæ¡ˆ', 'aborted': 'å·²ä¸­æ­¢' },
                    dataReady: false, isSubmitting: false,
                    tempCompletionData: null,
                    ganttCellWidth: 40, isDraggingGantt: false, startGanttX: 0, scrollLeftGantt: 0,
                    workspaceTab: 'tasks',
                    showMobileSidebar: false,
                    hasCheckedDailyTasks: false
                }
            },
            async mounted() {
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        this.userParams = user;
                        const q = query(collection(db, "users"), where("email", "==", user.email));
                        const snapshot = await getDocs(q);
                        if (!snapshot.empty) this.currentUserId = snapshot.docs[0].id;
                        else { 
                            const newUser = { name: user.email.split('@')[0], email: user.email, role: 'member', team: 'mkgt' }; 
                            const docRef = await addDoc(collection(db, "users"), newUser); 
                            this.currentUserId = docRef.id; 
                        }
                        this.initListeners();
                    } else { this.userParams = null; this.currentUserId = null; this.dataReady = false; }
                });
            },
            computed: {
                currentUser() { return (this.users || []).find(u => u.id === this.currentUserId) || { name: 'Guest', team: 'mkgt', role: 'member' }; },
                canEditSubProject() { if(!this.currentSubProject) return false; if(this.currentSubProject.status === 'completed' || this.currentSubProject.status === 'aborted') return false; if(this.currentUser.role !== 'member') return true; return this.currentSubProject.assignee === this.currentUser.name || this.currentSubProject.currentHandler === this.currentUser.name; },
                sortedBrands() { return [...this.brands].sort((a, b) => a.name.localeCompare(b.name, 'zh-TW')); },
                visibleBrands() { if (!this.sidebarSearch) return this.sortedBrands; const search = this.sidebarSearch.toLowerCase(); return this.sortedBrands.filter(b => { if (b.name.toLowerCase().includes(search)) return true; const projects = this.rawParents.filter(p => p.brandId === b.id && p.status === 'active'); return projects.some(p => p.title.toLowerCase().includes(search)); }); },
                sortedMilestones() { if(!this.currentSubProject) return []; return [...(this.currentSubProject.milestones || [])].sort((a,b) => new Date(a.date) - new Date(b.date)); },
                archivedProjects() { return this.rawParents.filter(p => p.status === 'completed' || p.status === 'aborted'); },
                unreadNotificationsCount() { return this.notifications.filter(n => !n.read).length; },
                modalTitle() { 
                    if (this.modalMode === 'parent_abort') return 'ä¸­æ­¢æ¯å°ˆæ¡ˆ'; 
                    if (this.modalMode === 'sub_abort') return 'ä¸­æ­¢å­å°ˆæ¡ˆ';
                    if (this.modalMode === 'sub_delay_complete') return 'å°ˆæ¡ˆå»¶èª¤çµæ¡ˆ - è«‹èªªæ˜åŸå› '; 
                    return 'ç¢ºèªçµæ¡ˆ (å®Œæˆ)'; 
                },
                getSubsForParent() { return (pid) => this.indexedSubsByParent[pid] || []; },
                myHandledBranches() {
                    const list = [];
                    this.rawParents.forEach(p => {
                        const subs = this.indexedSubsByParent[p.id] || [];
                        const brandName = this.indexedBrandMap[p.brandId] || 'Unknown';
                        subs.forEach(sp => {
                            if (sp.currentHandler === this.currentUser.name && sp.status === 'in_progress') {
                                list.push({ brand: {name: brandName}, parent: p, sub: sp });
                            }
                        });
                    });
                    return list;
                },
                allSubProjects() {
                    const list = [];
                    this.rawParents.forEach(p => {
                        if (this.selectedDashboardBrand !== 'all' && p.brandId !== this.selectedDashboardBrand) return;
                        const subs = this.indexedSubsByParent[p.id] || [];
                        const brandName = this.indexedBrandMap[p.brandId] || 'Unknown';
                        subs.forEach(sp => { list.push({ brand: {name: brandName}, parent: p, branch: sp }); });
                    });
                    return list;
                },
                filteredMonitorList() {
                    const candidates = this.allSubProjects.filter(i => (i.branch.status === 'in_progress')); 
                    candidates.sort((a, b) => {
                        const dateA = new Date(a.parent.startDate || '1970-01-01');
                        const dateB = new Date(b.parent.startDate || '1970-01-01');
                        if (dateA.getTime() !== dateB.getTime()) return dateA - dateB;
                        if (a.parent.title !== b.parent.title) return a.parent.title.localeCompare(b.parent.title, 'zh-TW');
                        const subEndA = new Date(a.branch.endDate || '9999-12-31');
                        const subEndB = new Date(b.branch.endDate || '9999-12-31');
                        return subEndA - subEndB;
                    });
                    if (this.filterStatus === 'all') return candidates;
                    if (this.filterStatus === 'delayed') return candidates.filter(i => this.getProjectHealth(i.branch).type === 'delay');
                    return candidates;
                },
                scopedStats() {
                    let activeCount=0, activeDelay=0, activeDelayDays=0;
                    let overallCount=0, overallDelay=0, overallDelayDays=0;
                    let activeReasons={}, overallReasons={}, archivedList=[];
                    let totalPeriodHours = 0; 

                    this.allSubProjects.forEach(item => {
                        const sp = item.branch;
                        
                        // è¨ˆç®—å€é–“å…§çš„ç¸½å·¥æ™‚ (ç”¨æ–¼ä¸Šæ–¹å¡ç‰‡æ•¸æ“š)
                        (sp.events || []).forEach(ev => { 
                            if (this.checkDateMatch(ev.date)) {
                                totalPeriodHours += Number(ev.hours || 0); 
                            }
                        });

                        // å„€è¡¨æ¿ï¼šåŸ·è¡Œä¸­æ•¸æ“š
                        if(sp.status === 'in_progress') {
                            activeCount++;
                            const d = this.getProjectHealth(sp);
                            if(d.type === 'delay') { activeDelay++; activeDelayDays += d.days; }
                            if(sp.delayReason) activeReasons[sp.delayReason] = (activeReasons[sp.delayReason] || 0) + 1;
                        }

                        // æ­·å²å ±è¡¨ï¼šæ­¸æª”æ•¸æ“š
                        if(this.currentView === 'history_report') {
                             // æª¢æŸ¥æ˜¯å¦ç¬¦åˆç¯©é¸æ—¥æœŸ
                             const isMatch = this.checkDateMatch(sp.completedDate || sp.endDate);
                             
                             if((sp.status === 'completed' || sp.status === 'aborted') && isMatch) {
                                overallCount++;
                                
                                // â˜…â˜…â˜… [ä¿®æ­£] é€™è£¡åŠ å…¥è¨ˆç®—å–®ä¸€å°ˆæ¡ˆç¸½å·¥æ™‚ï¼Œè®“åˆ—è¡¨å¯ä»¥é¡¯ç¤º â˜…â˜…â˜…
                                sp.actHours = this.calcSubProjectHours(sp);
                                
                                archivedList.push(item);

                                const d = sp.finalDelayDays || 0;
                                if(d > 0 && sp.status !== 'aborted') { overallDelay++; overallDelayDays += d; }
                                if(sp.delayReason) overallReasons[sp.delayReason] = (overallReasons[sp.delayReason] || 0) + 1;
                             }
                        }
                    });

                    return {
                        active: { count: activeCount, delayRate: activeCount?Math.round(activeDelay/activeCount*100):0, totalDelayDays: activeDelayDays, reasonList: this.objToArr(activeReasons, activeCount) },
                        overall: { totalProjects: overallCount, delayRate: overallCount?Math.round(overallDelay/overallCount*100):0, totalDelayDays: overallDelayDays, reasonList: this.objToArr(overallReasons, overallCount) },
                        archivedList,
                        archivedHours: totalPeriodHours
                    };
                },
                currentProjectStats() {
                    if (!this.currentParentProject) return {};
                    const subs = this.indexedSubsByParent[this.currentParentProject.id] || [];
                    let act=0, delays=0, completed=0, totalPercent=0, maxDelay=0;
                    subs.forEach(sp => {
                        act += this.calcSubProjectHours(sp);
                        const h = this.getProjectHealth(sp);
                        if(sp.status !== 'aborted' && h.type === 'delay') { delays++; maxDelay = Math.max(maxDelay, h.days); }
                        if(sp.status === 'completed') completed++;
                        const tm = sp.milestones?.length || 0;
                        const dm = sp.milestones?.filter(m=>m.isCompleted).length || 0;
                        totalPercent += tm ? (dm/tm*100) : 0;
                    });
                    return { total: subs.length, completed, act, delays, maxDelay, progress: subs.length ? Math.round(totalPercent/subs.length) : 0 };
                },
                
                // --- è«‹æ›¿æ› computed å…§çš„ calendarDays ---
                calendarDays() {
                    const days = [];
                    const firstDayOfMonth = new Date(this.calendarYear, this.calendarMonth - 1, 1);
                    const lastDayOfMonth = new Date(this.calendarYear, this.calendarMonth, 0);
                    const startDay = new Date(firstDayOfMonth);
                    startDay.setDate(1 - firstDayOfMonth.getDay());
                    const endDay = new Date(lastDayOfMonth);
                    endDay.setDate(lastDayOfMonth.getDate() + (6 - lastDayOfMonth.getDay()));
                    const totalDays = Math.round((endDay - startDay) / (1000 * 60 * 60 * 24)) + 1;
                    const todayStr = new Date().toLocaleDateString('en-CA', { timeZone: 'Asia/Taipei' });
                    
                    for (let i = 0; i < totalDays; i++) {
                        const current = new Date(startDay);
                        current.setDate(startDay.getDate() + i);
                        const isoDate = current.toLocaleDateString('en-CA', { timeZone: 'Asia/Taipei' });
                        const isCurrentMonth = current.getMonth() === (this.calendarMonth - 1);
                        days.push({ date: current.getDate(), isCurrentMonth, isToday: isoDate === todayStr, isoDate, events: [] });
                    }

                    this.allSubProjects.forEach(item => {
                        const sp = item.branch;
                        // ç¯©é¸ï¼šåªé¡¯ç¤ºèˆ‡æˆ‘ç›¸é—œçš„å°ˆæ¡ˆ
                        const isMine = item.parent.owner === this.currentUser.name || sp.assignee === this.currentUser.name || sp.currentHandler === this.currentUser.name;
                        if (!isMine) return;

                        // å–å¾—å“ç‰Œåç¨±
                        const brandPrefix = item.brand ? `[${item.brand.name}] ` : '';

                        if(sp.endDate) {
                            const day = days.find(d => d.isoDate === sp.endDate);
                            if(day) day.events.push({ 
                                id: sp.id, 
                                title: `${brandPrefix}${sp.title}`, // åŠ ä¸Šå“ç‰Œåç¨±
                                type: 'deadline', 
                                sub: sp, 
                                parent: item.parent 
                            });
                        }
                        (sp.milestones || []).forEach(m => {
                            if(m.date) {
                                const day = days.find(d => d.isoDate === m.date);
                                if(day) day.events.push({ 
                                    id: m.id, 
                                    title: `${brandPrefix} ${m.title}`, // åŠ ä¸Šå“ç‰Œåç¨±
                                    type: 'milestone', 
                                    sub: sp, 
                                    parent: item.parent 
                                });
                            }
                        });
                    });
                    return days;
                },
                // ----------------------------------------------------

                memberStats() {
                    return this.users.map(m => {
                        let active = 0, delay = 0;
                        this.allSubProjects.forEach(item => {
                            const sp = item.branch;
                            if (sp.assignee === m.name || sp.currentHandler === m.name) {
                                if (sp.status === 'in_progress') active++;
                                if (sp.status !== 'aborted' && this.getProjectHealth(sp).type === 'delay') delay++;
                            }
                        });
                        return { id: m.id, name: m.name, team: m.team, activeBranches: active, delayCount: delay };
                    });
                },
                myOwnedBranches() {
                    const list = [];
                    this.rawParents.filter(p => p.owner === this.currentUser.name && p.status==='active').forEach(p => {
                        list.push({ brand: {name: this.indexedBrandMap[p.brandId]}, project: p, isParent: true, sortDate: p.endDate });
                    });
                    this.allSubProjects.filter(i => i.branch.assignee === this.currentUser.name && i.branch.status !== 'completed' && i.branch.status !== 'aborted').forEach(i => {
                        list.push({ brand: i.brand, parent: i.parent, sub: i.branch, isParent: false, sortDate: i.branch.endDate });
                    });
                    return list.sort((a,b) => {
                        if (a.isParent && !b.isParent) return -1; 
                        if (!a.isParent && b.isParent) return 1;
                        const da = a.sortDate ? new Date(a.sortDate) : new Date(9999,11,31);
                        const db = b.sortDate ? new Date(b.sortDate) : new Date(9999,11,31);
                        return da - db;
                    });
                },
                incompleteMilestones() { 
                    if (!this.currentSubProject?.milestones) return [];
                    const sorted = [...this.currentSubProject.milestones].sort((a,b) => new Date(a.date) - new Date(b.date));
                    return sorted.filter(m => !m.isCompleted).slice(0, 1); 
                },
                memberHoursStats() {
                    const stats = {}; 
                    this.users.forEach(u => stats[u.name] = { name: u.name, team: u.team, hours: 0 });
                    this.allSubProjects.forEach(item => {
                        const sp = item.branch;
                        if (sp.events) {
                            sp.events.forEach(ev => {
                                if (this.checkDateMatch(ev.date) && stats[ev.worker]) stats[ev.worker].hours += Number(ev.hours || 0);
                            });
                        }
                    });
                    return Object.values(stats).filter(s => s.hours > 0).sort((a, b) => b.hours - a.hours);
                },
                departmentHours() {
                    const deptStats = {}; let totalAll = 0;
                    this.memberHoursStats.forEach(m => {
                        if (!deptStats[m.team]) deptStats[m.team] = 0;
                        deptStats[m.team] += m.hours; totalAll += m.hours;
                    });
                    return Object.entries(deptStats).map(([team, hours]) => ({
                        name: team, hours: hours, percent: totalAll ? Math.round((hours / totalAll) * 100) : 0
                    })).sort((a, b) => b.hours - a.hours);
                },
            },
            methods: {
                requestNotificationPermission() {
                    if (!("Notification" in window)) return;
                    if (Notification.permission !== "granted" && Notification.permission !== "denied") {
                        Notification.requestPermission();
                    }
                },
                sendBrowserNotification(title, body, tag = null) {
                    if (Notification.permission === "granted") {
                        new Notification(`[ä¸Šæ´‹æˆ°æƒ…å®¤] ${title}`, { 
                            body, tag, icon: 'https://www.upyoung.com.tw/assets/images/logo.png' 
                        });
                    }
                },
                checkDailyTasks() {
                    if (this.hasCheckedDailyTasks) return;
                    const today = new Date().toLocaleDateString('en-CA', { timeZone: 'Asia/Taipei' });
                    const myTasks = this.myHandledBranches;
                    myTasks.forEach(item => {
                        const sp = item.sub;
                        if (!sp.endDate) return;
                        if (sp.endDate === today) {
                            this.sendBrowserNotification("ä»Šæ—¥æˆªæ­¢æé†’", `é€šçŸ¥åŸå› ï¼šå·¥ä½œã€Œ${sp.title}ã€ä»Šæ—¥æˆªæ­¢ï¼Œè«‹ç¢ºèªé€²åº¦ã€‚`, `today-${sp.id}`);
                        } else if (sp.endDate < today) {
                            const days = Math.floor((new Date(today) - new Date(sp.endDate)) / 86400000);
                            this.sendBrowserNotification("é€¾æœŸè™•ç†æé†’", `é€šçŸ¥åŸå› ï¼šå·¥ä½œã€Œ${sp.title}ã€å·²é€¾æœŸ ${days} å¤©å°šæœªè™•ç†å®Œæˆã€‚`, `overdue-${sp.id}`);
                        }
                    });
                    this.hasCheckedDailyTasks = true;
                },
                initListeners() {
                    try {
                        this.requestNotificationPermission();
                        let loadCount = 0;
                        const checkReady = () => { 
                            loadCount++; 
                            if(loadCount >= 4) { 
                                this.buildIndexes(); this.dataReady = true; 
                                setTimeout(() => this.checkDailyTasks(), 2000);
                            } 
                        };
                        const safeProject = (d) => ({ id: d.id, brandId:'', title:'Untitled', status:'active', startDate:'', endDate:'', owner:'Unknown', ...d.data() });
                        const safeSub = (d) => {
                            const data = d.data();
                            return { id: d.id, parentId:'', title:'Untitled', status:'setup', ...data, milestones: data.milestones||[], events: data.events||[], links: data.links||[], comments: data.comments||[] };
                        };
                        onSnapshot(collection(db, "users"), (s) => { this.users = s.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => (a.team||'').localeCompare(b.team||'')); checkReady(); }); 
                        onSnapshot(collection(db, "brands"), (s) => { this.brands = s.docs.map(d => ({id: d.id, ...d.data()})); checkReady(); }); 
                        onSnapshot(collection(db, "projects"), (s) => { this.rawParents = s.docs.map(d => safeProject(d)); checkReady(); });
                        onSnapshot(collection(db, "sub_projects"), (s) => { this.rawSubs = s.docs.map(d => safeSub(d)); checkReady(); });

                        this.$watch(() => this.currentUser?.name, (newVal) => { 
                            if(newVal) { 
                                onSnapshot(query(collection(db, "notifications"), where("recipient", "==", newVal)), (snap) => { 
                                    const oldLen = this.notifications.length;
                                    this.notifications = snap.docs.map(d => ({id:d.id, ...d.data()})).sort((a,b) => new Date(b.time) - new Date(a.time)); 
                                    if (this.dataReady && this.notifications.length > oldLen) {
                                        const latest = this.notifications[0];
                                        if (!latest.read && latest.sender !== this.currentUser.name) {
                                            this.sendBrowserNotification("æ”¶åˆ°æ–°é€šçŸ¥", `é€šçŸ¥åŸå› ï¼š${latest.message}`, `notif-${latest.id}`);
                                        }
                                    }
                                }); 
                            } 
                        });
                    } catch (e) { console.error(e); this.dataReady = true; }
                },
                buildIndexes() {
                    const subMap = {};
                    this.rawSubs.forEach(s => { if (!subMap[s.parentId]) subMap[s.parentId] = []; subMap[s.parentId].push(s); });
                    this.indexedSubsByParent = subMap;
                    const pMap = {}; this.rawParents.forEach(p => pMap[p.id] = p); this.indexedParentMap = pMap;
                    const bMap = {}; this.brands.forEach(b => bMap[b.id] = b.name); this.indexedBrandMap = bMap;
                },
                rebuildBrandMap() {
                    const bMap = {};
                    this.brands.forEach(b => bMap[b.id] = b.name);
                    this.indexedBrandMap = bMap;
                },
                
                openMemberDetail(m) { 
                    this.currentMemberDetail = m; 
                    this.recalcMemberDetail(); 
                    this.showMemberDetailModal = true; 
                },
                recalcMemberDetail() { 
                    const m = this.currentMemberDetail; 
                    let activeCount = 0, holdDaysSum = 0, activeTasks = [], overallCount = 0, overallDelay = 0, overallDelayDays = 0, overallReasons = {}, ownedList = []; 
                    
                    this.allSubProjects.forEach(item => { 
                        const sp = item.branch; 
                        if(sp.currentHandler === m.name && sp.status === 'in_progress') { 
                            activeCount++; 
                            const hd = this.getDaysHeld(sp.lastHandoffDate); 
                            holdDaysSum += hd; 
                            activeTasks.push({ parent: item.parent, sub: sp, holdDays: hd }); 
                        } 
                        if(sp.assignee === m.name) { 
                            if (this.memberDetailYear === 'all' || (sp.endDate && sp.endDate.startsWith(this.memberDetailYear))) { 
                                overallCount++; 
                                const d = sp.finalDelayDays !== undefined ? sp.finalDelayDays : this.getSubProjectDelayDays(sp); 
                                if(d > 0 && sp.status !== 'aborted') { overallDelay++; overallDelayDays += d; } 
                                if((sp.status === 'completed' || sp.status === 'aborted') && sp.delayReason) overallReasons[sp.delayReason] = (overallReasons[sp.delayReason] || 0) + 1; 
                                ownedList.push({ parent: item.parent, sub: sp }); 
                            } 
                        } 
                    }); 
                    
                    this.memberDetailData = { 
                        active: { 
                            count: activeCount, 
                            avgHoldDays: activeCount === 0 ? 0 : Math.round(holdDaysSum / activeCount), 
                            tasks: activeTasks.sort((a,b) => b.holdDays - a.holdDays) 
                        }, 
                        overall: { 
                            total: overallCount, 
                            delayRate: overallCount === 0 ? 0 : Math.round((overallDelay / overallCount) * 100), 
                            totalDelayDays: overallDelayDays, 
                            reasons: Object.entries(overallReasons).map(([k,v]) => ({name: k, count: v, percent: Math.round(v/overallCount*100) || 0})).sort((a,b) => b.count - a.count), 
                            projects: ownedList.sort((a,b) => new Date(b.sub.endDate) - new Date(a.sub.endDate)) 
                        } 
                    }; 
                },

                objToArr(obj, total) { return Object.entries(obj).map(([k,v]) => ({name: k, count: v, percent: total?Math.round(v/total*100):0})).sort((a,b)=>b.count-a.count); },
                checkDateMatch(dStr) { if(!dStr) return false; const d = new Date(dStr); return d.getFullYear() === this.currentYear && (this.currentMonth === 'all' || d.getMonth()+1 === this.currentMonth); },
                toggleAuthMode() { this.isRegisterMode = !this.isRegisterMode; this.authError = ''; },
                async handleAuth() { try { if (this.isRegisterMode) { if(!this.authForm.name) throw new Error("è«‹è¼¸å…¥å§“å"); await createUserWithEmailAndPassword(auth, this.authForm.email, this.authForm.password); await addDoc(collection(db, "users"), { email: this.authForm.email, name: this.authForm.name, team: this.authForm.team, role: this.authForm.role }); } else { await signInWithEmailAndPassword(auth, this.authForm.email, this.authForm.password); } } catch (e) { this.authError = e.message.replace("Firebase: ", ""); } },
                logout() { signOut(auth); },
                async addBrand() { const n = prompt("å“ç‰Œ:"); if(n) await addDoc(collection(db, "brands"), { name: n }); },
                toggleBrand(id) { this.brandExpandedState[id] = !this.brandExpandedState[id]; },
                isBrandExpanded(id) { if (this.sidebarSearch) return true; return !!this.brandExpandedState[id]; },
                getMatchingProjects(brandId) {
                    let projects = this.rawParents.filter(p => p.brandId === brandId && p.status === 'active');
                    projects.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
                    if (!this.sidebarSearch) return projects;
                    const search = this.sidebarSearch.toLowerCase();
                    return projects.filter(p => p.title.toLowerCase().includes(search));
                },
                getArchivedProjectsByBrand(bid) { return this.rawParents.filter(p => p.brandId === bid && (p.status === 'completed' || p.status === 'aborted')); },
                getSortedSubs(pid) {
                    const subs = this.indexedSubsByParent[pid] || [];
                    return [...subs].sort((a, b) => {
                        const aActive = (a.status === 'in_progress' || a.status === 'setup');
                        const bActive = (b.status === 'in_progress' || b.status === 'setup');
                        if (aActive && !bActive) return -1; if (!aActive && bActive) return 1;
                        return new Date(a.endDate) - new Date(b.endDate);
                    });
                },
                startDrag(e) { this.isDraggingGantt = true; this.startGanttX = e.pageX - this.$refs.ganttContainer.offsetLeft; this.scrollLeftGantt = this.$refs.ganttContainer.scrollLeft; },
                doDrag(e) { if (!this.isDraggingGantt) return; e.preventDefault(); const x = e.pageX - this.$refs.ganttContainer.offsetLeft; const walk = (x - this.startGanttX) * 2; this.$refs.ganttContainer.scrollLeft = this.scrollLeftGantt - walk; },
                stopDrag() { this.isDraggingGantt = false; },
                changeGanttZoom(delta) { this.ganttCellWidth = Math.max(20, Math.min(100, this.ganttCellWidth + delta)); },
                getGanttDays(project) {
                    if (!project.startDate || !project.endDate) return [];
                    const start = new Date(project.startDate); const end = new Date(project.endDate);
                    start.setDate(start.getDate() - 2); end.setDate(end.getDate() + 5);
                    const days = []; const curr = new Date(start);
                    while (curr <= end) {
                        const day = curr.getDay();
                        days.push({ iso: curr.toLocaleDateString('en-CA', { timeZone: 'Asia/Taipei' }), label: `${curr.getMonth()+1}/${curr.getDate()}`, isWeekend: day === 0 || day === 6 });
                        curr.setDate(curr.getDate() + 1);
                    }
                    return days;
                },
                getDynamicGanttBarStyles(sp, parent) {
                    if (!sp.startDate || !sp.endDate) return 'display: none';
                    const allDays = this.getGanttDays(parent);
                    if (allDays.length === 0) return 'display: none';
                    const startDayIndex = allDays.findIndex(d => d.iso === sp.startDate);
                    const endDayIndex = allDays.findIndex(d => d.iso === sp.endDate);
                    if (startDayIndex === -1) return 'display: none'; 
                    const left = startDayIndex * this.ganttCellWidth;
                    const width = ((endDayIndex === -1 ? allDays.length - 1 : endDayIndex) - startDayIndex + 1) * this.ganttCellWidth;
                    return `left: ${left}px; width: ${Math.max(this.ganttCellWidth, width)}px`;
                },
                openProjectModal(bid) { this.projectForm = { brandId: bid, title: '', startDate: new Date().toISOString().split('T')[0], endDate: '' }; this.showProjectModal = true; },
                async saveProject() { 
                    if(!this.projectForm.title) return alert("è«‹å¡«å¯«è³‡è¨Š"); this.isSubmitting = true;
                    try { await addDoc(collection(db, "projects"), DataFactory.createProject(this.projectForm, this.currentUser)); this.showProjectModal = false; } catch(e) { console.error(e); } finally { this.isSubmitting = false; }
                },
                openBranchModal(pid) { this.subProjectForm = { parentId: pid, title: '', assignee: this.currentUser.name }; this.showSubProjectModal = true; },
                async saveSubProject() { 
                    if (!this.subProjectForm.title) return alert("è«‹å¡«å¯«åç¨±"); this.isSubmitting = true;
                    try { 
                        const newSub = DataFactory.createSubProject(this.subProjectForm, this.currentUser);
                        const docRef = await addDoc(collection(db, "sub_projects"), newSub); 
                        if (newSub.assignee !== this.currentUser.name) this.sendNotification(newSub.assignee, 'task', `æ‚¨è¢«æŒ‡æ´¾è² è²¬æ–°å°ˆæ¡ˆ: ${newSub.title}`, this.subProjectForm.parentId, docRef.id); 
                        this.showSubProjectModal = false; 
                    } catch(e) { console.error(e); alert("Error"); }
                    finally { this.isSubmitting = false; }
                },
                openEditBranchModal() { this.editBranchForm = JSON.parse(JSON.stringify(this.currentSubProject)); this.showEditBranchModal = true; },
                async saveEditedBranch() { 
                    this.isSubmitting = true;
                    try {
                        await updateDoc(doc(db, "sub_projects", this.currentSubProject.id), this.editBranchForm); 
                        if(this.editBranchForm.assignee !== this.currentSubProject.assignee) { this.sendNotification(this.editBranchForm.assignee, 'task', `æ‚¨è¢«æŒ‡æ´¾è² è²¬å°ˆæ¡ˆ: ${this.editBranchForm.title}`, this.currentParentProject.id, this.currentSubProject.id); } 
                        this.showEditBranchModal = false; 
                    } finally { this.isSubmitting = false; }
                },
                addSetupMilestone() { this.setupForm.milestones.push({ id: 'ms'+Date.now(), date: '', title: '', isCompleted: false }); },
                async confirmSetup() { 
                    if (this.currentSubProject.assignee !== this.currentUser.name) return alert("æ¬Šé™ä¸è¶³ï¼šåªæœ‰å°ˆæ¡ˆè² è²¬äººæ‰èƒ½é€²è¡Œè¦åŠƒè¨­å®š");
                    if (!this.setupForm.startDate) return alert("è«‹è¨­å®šå°ˆæ¡ˆé–‹å§‹æ—¥æœŸ");
                    if (this.setupForm.milestones.length === 0) return alert("è«‹è‡³å°‘å»ºç«‹ä¸€å€‹é‡Œç¨‹ç¢‘ç¯€é»");
                    this.setupForm.milestones.sort((a, b) => new Date(a.date) - new Date(b.date));
                    this.setupForm.endDate = this.setupForm.milestones[this.setupForm.milestones.length - 1].date; 
                    if (this.setupForm.startDate < this.currentParentProject.startDate) return alert(`å­å°ˆæ¡ˆé–‹å§‹æ—¥ä¸èƒ½æ—©æ–¼æ¯å°ˆæ¡ˆ (${this.currentParentProject.startDate})`);
                    this.isSubmitting = true;
                    try { 
                        await updateDoc(doc(db, "sub_projects", this.currentSubProject.id), { ...this.setupForm, status: 'in_progress' });
                        Object.assign(this.currentSubProject, { ...this.setupForm, status: 'in_progress' });
                        this.setupForm = { startDate: '', endDate: '', milestones: [] }; 
                    }
                    catch (e) { console.error(e); alert("æ›´æ–°å¤±æ•—"); }
                    finally { this.isSubmitting = false; }
                },
                async addResourceLink() { 
                    const title = prompt("é€£çµåç¨±:"); if (!title) return; 
                    const url = prompt("ç¶²å€ (URL):"); if (!url) return; 
                    const newLinkObj = { title, url };
                    const links = [...(this.currentSubProject.links || []), newLinkObj]; 
                    await updateDoc(doc(db, "sub_projects", this.currentSubProject.id), { links }); 
                    if (!this.currentSubProject.links) this.currentSubProject.links = [];
                    this.currentSubProject.links.push(newLinkObj);
                },
                async addComment() { 
                    if (!this.newComment.trim()) return; 
                    const content = this.newComment;
                    const newCommentObj = { id: 'c'+Date.now(), user: this.currentUser.name, content: content, time: new Date().toLocaleString() };
                    if (!this.currentSubProject.comments) this.currentSubProject.comments = [];
                    this.currentSubProject.comments.push(newCommentObj); 
                    this.newComment = ''; 
                    this.showMentionList = false;
                    try {
                        await updateDoc(doc(db, "sub_projects", this.currentSubProject.id), { comments: this.currentSubProject.comments }); 
                        const matches = [...content.matchAll(/@(\S+)/g)];
                        const uniqueNames = [...new Set(matches.map(m => m[1]))];
                        uniqueNames.forEach(async name => {
                            const targetUser = this.users.find(u => u.name === name);
                            if (targetUser && targetUser.name !== this.currentUser.name) {
                                await this.sendNotification(targetUser.name, 'task', `${this.currentUser.name} åœ¨ç•™è¨€ä¸­æåŠäº†æ‚¨: ${content}`, this.currentParentProject.id, this.currentSubProject.id);
                            }
                        });
                    } catch (e) { console.error("Comment Error", e); }
                },
                checkForMention() { this.showMentionList = this.newComment.endsWith('@'); },
                selectMention(name) { 
                    this.newComment += name + ' '; 
                    this.showMentionList = false; 
                    this.$nextTick(() => { const input = this.$el.querySelector('input[placeholder*="ç•™è¨€"]'); if(input) input.focus(); });
                },
                changeMonth(delta) { this.calendarMonth += delta; if(this.calendarMonth > 12) { this.calendarMonth = 1; this.calendarYear++; } else if(this.calendarMonth < 1) { this.calendarMonth = 12; this.calendarYear--; } },
                openEventModal() { 
                    if (this.currentSubProject.currentHandler !== this.currentUser.name) return alert("åªæœ‰ç›®å‰è² è²¬äºº (çƒåœ¨æ‰‹ä¸Š) æ‰èƒ½æ–°å¢å·¥ä½œæ—¥èªŒ");
                    this.eventForm = { date: new Date().toISOString().split('T')[0], hours: 0, worker: this.currentUser.name, nextAssignee: this.currentSubProject.currentHandler || this.currentSubProject.assignee, description: '', matchedMilestoneId: '' }; 
                    this.showEventModal = true; 
                },
                async saveEvent() {
                    if (this.currentSubProject.currentHandler !== this.currentUser.name) return;
                    if (new Date(this.eventForm.date) < new Date(this.currentSubProject.startDate)) {
                        alert(`å·¥ä½œæ—¥èªŒæ—¥æœŸ (${this.eventForm.date}) ä¸å¯æ—©æ–¼å­å°ˆæ¡ˆé–‹å§‹æ—¥ (${this.currentSubProject.startDate})`);
                        return;
                    }
                    if (this.currentSubProject.events && this.currentSubProject.events.length > 0) {
                        const lastEventDate = this.currentSubProject.events.reduce((latest, ev) => {
                            return new Date(ev.date) > new Date(latest) ? ev.date : latest;
                        }, this.currentSubProject.events[0].date);
                        if (new Date(this.eventForm.date) < new Date(lastEventDate)) {
                            alert(`å·¥ä½œæ—¥èªŒæ—¥æœŸ (${this.eventForm.date}) ä¸å¾—æ—©æ–¼æœ€å¾Œä¸€ç­†è¨˜éŒ„æ—¥æœŸ (${lastEventDate})`);
                            return;
                        }
                    }
                    const newEvent = { id: 'ev'+Date.now(), ...this.eventForm, handoffTo: this.eventForm.nextAssignee !== this.currentUser.name ? this.eventForm.nextAssignee : null };
                    const nextHandler = this.eventForm.nextAssignee;
                    const isHandoff = nextHandler !== this.currentUser.name;
                    let isProjectCompleted = false;
                    let delayDetected = false;

                    if(!this.currentSubProject.events) this.currentSubProject.events = [];
                    this.currentSubProject.events.push(newEvent);
                    const oldHandler = this.currentSubProject.currentHandler;
                    this.currentSubProject.currentHandler = nextHandler;
                    
                    if (this.eventForm.matchedMilestoneId) {
                        const sortedMilestones = [...this.currentSubProject.milestones].sort((a, b) => new Date(a.date) - new Date(b.date));
                        const lastMilestone = sortedMilestones[sortedMilestones.length - 1];
                        const ms = this.currentSubProject.milestones.find(m => m.id === this.eventForm.matchedMilestoneId);
                        if (ms) {
                            ms.isCompleted = true;
                            ms.completedDate = this.eventForm.date;
                            ms.diffDays = Math.floor((new Date(this.eventForm.date) - new Date(ms.date)) / 86400000);
                            if (ms.id === lastMilestone.id) {
                                const today = new Date(this.eventForm.date);
                                const deadline = new Date(this.currentSubProject.endDate);
                                const finalDelay = Math.floor((today - deadline) / 86400000);
                                if (finalDelay > 0) {
                                    delayDetected = true;
                                    this.currentSubProject.events.pop();
                                    this.currentSubProject.currentHandler = oldHandler;
                                    ms.isCompleted = false; 
                                    this.tempCompletionData = { finalDelay, newEvent, milestoneId: ms.id, nextHandler };
                                    this.showEventModal = false;
                                    this.modalMode = 'sub_delay_complete';
                                    this.delayForm = { reason: 'äººåŠ›ä¸è¶³', remark: '' }; 
                                    this.showDelayReasonModal = true;
                                    return; 
                                } else {
                                    isProjectCompleted = true;
                                    this.currentSubProject.status = 'completed'; 
                                    this.currentSubProject.finalDelayDays = 0;
                                    this.currentSubProject.completedDate = this.eventForm.date; 
                                    alert("æ­å–œï¼å°ˆæ¡ˆæº–æ™‚å®Œæˆï¼Œè‡ªå‹•çµæ¡ˆã€‚");
                                }
                            }
                        }
                    }
                    this.showEventModal = false;
                    try {
                        const updates = { 
                            events: this.currentSubProject.events, 
                            currentHandler: nextHandler,
                            milestones: this.currentSubProject.milestones
                        };
                        if (isHandoff) {
                            updates.lastHandoffDate = this.eventForm.date;
                            this.sendNotification(nextHandler, 'handoff', `æ”¶åˆ°å·¥ä½œäº¤æ¥: ${this.currentSubProject.title}`, this.currentParentProject.id, this.currentSubProject.id);
                        }
                        if (isProjectCompleted) {
                            updates.status = 'completed';
                            updates.finalDelayDays = 0;
                            updates.completedDate = this.eventForm.date;
                        }
                        await updateDoc(doc(db, "sub_projects", this.currentSubProject.id), updates);
                    } catch (e) {
                        console.error("Sync Failed", e);
                    }
                },
                async sendNotification(recipient, type, message, pid, sid) { await addDoc(collection(db, "notifications"), { recipient, type, message, projectId: pid, subProjectId: sid, read: false, time: new Date().toLocaleString(), sender: this.currentUser.name }); },
                async handleNotificationClick(n) { const notifRef = doc(db, "notifications", n.id); await updateDoc(notifRef, { read: true }); const parent = this.indexedParentMap[n.projectId]; if (parent) { const subs = this.indexedSubsByParent[n.projectId] || []; const sub = subs.find(s => s.id === n.subProjectId); if (sub) this.selectSubProject(sub, parent); } this.showNotifications = false; },
                async clearAllNotifications() { this.notifications.forEach(async n => { await deleteDoc(doc(db, "notifications", n.id)); }); this.notifications = []; },
                addToHistory() { this.historyStack.push({ view: this.currentView, parentId: this.currentParentProject?.id, subId: this.currentSubProject?.id }); },
                goBack() { 
                    const prev = this.historyStack.pop(); 
                    if (prev) { 
                        this.currentView = prev.view; 
                        if (prev.view === 'parent_detail' && prev.parentId) {
                            this.currentParentProject = this.indexedParentMap[prev.parentId];
                            this.detailTab = 'overview'; 
                        }
                    } else { 
                        this.currentView = 'dashboard'; 
                    } 
                },
                selectParentProject(proj) { this.addToHistory(); this.currentParentProject = proj; this.currentView = 'parent_detail'; this.detailTab = 'overview'; },
                selectSubProject(sp, parent) { this.addToHistory(); this.currentParentProject = parent; this.currentSubProject = sp; this.currentView = 'sub_project_detail'; this.setupForm = { startDate: new Date().toISOString().split('T')[0], endDate: '', milestones: [] }; this.detailTab = 'events'; },
                openCalendarSideEvent(ev) { this.calendarSideEvent = ev; },
                openParentAbortModal() { this.modalMode = 'parent_abort'; this.delayForm = { reason: 'ç­–ç•¥èª¿æ•´', remark: '' }; this.showDelayReasonModal = true; },
                openSubAbortModal() { this.modalMode = 'sub_abort'; this.delayForm = { reason: 'ç­–ç•¥èª¿æ•´', remark: '' }; this.showDelayReasonModal = true; },
                tryCompleteSubProject() { const delayDays = this.getSubProjectDelayDays(this.currentSubProject); const hasUnfinishedMilestones = (this.currentSubProject.milestones || []).some(m => !m.isCompleted); if (delayDays > 0 || hasUnfinishedMilestones) { this.modalMode = 'sub_complete'; this.delayForm = { reason: 'äººåŠ›ä¸è¶³', remark: '' }; this.showDelayReasonModal = true; } else { if(confirm("ç¢ºèªçµæ¡ˆï¼Ÿ")) this.finalizeSubProject(); } },
                async submitDelayModal() {
                    this.isSubmitting = true;
                    try {
                        if (this.modalMode === 'sub_delay_complete') {
                            const data = this.tempCompletionData;
                            if (!data) throw new Error("æš«å­˜è³‡æ–™éºå¤±ï¼Œè«‹é‡æ–°æ“ä½œ");
                            const ms = this.currentSubProject.milestones.find(m => m.id === data.milestoneId);
                            if(!this.currentSubProject.events) this.currentSubProject.events = [];
                            this.currentSubProject.events.push(data.newEvent);
                            this.currentSubProject.currentHandler = data.nextHandler;
                            if (ms) {
                                ms.isCompleted = true;
                                ms.completedDate = data.newEvent.date;
                                ms.diffDays = Math.floor((new Date(data.newEvent.date) - new Date(ms.date)) / 86400000);
                            }
                            this.currentSubProject.status = 'completed';
                            this.currentSubProject.finalDelayDays = data.finalDelay;
                            this.currentSubProject.delayReason = this.delayForm.reason;
                            this.currentSubProject.delayRemark = this.delayForm.remark;
                            this.currentSubProject.completedDate = data.newEvent.date;
                            await updateDoc(doc(db, "sub_projects", this.currentSubProject.id), {
                                events: this.currentSubProject.events,
                                currentHandler: data.nextHandler,
                                milestones: this.currentSubProject.milestones,
                                status: 'completed',
                                finalDelayDays: data.finalDelay,
                                delayReason: this.delayForm.reason,
                                delayRemark: this.delayForm.remark || '', 
                                completedDate: data.newEvent.date
                            });
                        } 
                        else if (this.modalMode === 'parent_abort') {
                            if(confirm("ç¢ºå®šä¸­æ­¢æ­¤æ¯å°ˆæ¡ˆï¼Ÿ")) {
                                await updateDoc(doc(db, "projects", this.currentParentProject.id), { 
                                    status: 'aborted', 
                                    delayReason: this.delayForm.reason, 
                                    delayRemark: this.delayForm.remark || '',  
                                });
                                this.currentView = 'dashboard';
                            }
                        } 
                        else if (this.modalMode === 'sub_abort') {
                            await updateDoc(doc(db, "sub_projects", this.currentSubProject.id), { 
                                status: 'aborted', 
                                delayReason: this.delayForm.reason, 
                                delayRemark: this.delayForm.remark || '',  
                            });
                            this.currentSubProject.status = 'aborted'; 
                        } 
                        else {
                            const currentDelay = this.getSubProjectDelayDays(this.currentSubProject);
                            const today = new Date().toLocaleDateString('en-CA', { timeZone: 'Asia/Taipei' });
                            await updateDoc(doc(db, "sub_projects", this.currentSubProject.id), { 
                                delayReason: this.delayForm.reason, 
                                delayRemark: this.delayForm.remark || '', 
                                finalDelayDays: currentDelay > 0 ? currentDelay : 0, 
                                status: 'completed',
                                completedDate: today 
                            });
                            this.currentSubProject.status = 'completed';
                            this.currentSubProject.finalDelayDays = currentDelay > 0 ? currentDelay : 0;
                        }
                        alert("è³‡æ–™å·²å„²å­˜");
                        this.showDelayReasonModal = false; 
                        this.delayForm = { reason: 'äººåŠ›ä¸è¶³', remark: '' }; 
                    } catch(e) {
                        console.error(e);
                        alert("å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–é‡è©¦ï¼š" + e.message);
                    } finally {
                        this.isSubmitting = false;
                    }
                },
                async finalizeSubProject() { 
                    this.isSubmitting = true;
                    try {
                        const d = this.getSubProjectDelayDays(this.currentSubProject); 
                        await updateDoc(doc(db, "sub_projects", this.currentSubProject.id), { status: 'completed', finalDelayDays: d > 0 ? d : 0 }); 
                    } finally { this.isSubmitting = false; }
                },
                async completeParentProject(proj) { if(confirm('å…¨æ¡ˆæ­¸æª”ï¼Ÿ')) await updateDoc(doc(db, "projects", proj.id), { status: 'completed' }); this.currentView = 'dashboard'; },
                exportHistoryReport() { const rows = [ ['å“ç‰Œ', 'æ¯å°ˆæ¡ˆ', 'å­å°ˆæ¡ˆ', 'è² è²¬äºº', 'çµæ¡ˆæ—¥æœŸ', 'ç¸½å·¥æ™‚', 'æœ€çµ‚ç‹€æ…‹', 'å»¶é²å¤©æ•¸', 'å»¶é²åŸå› '], ...this.scopedStats.archivedList.map(i => [ i.brand.name, i.parent.title, i.branch.title, i.branch.assignee, i.branch.endDate, i.branch.actHours || 0, i.branch.status, i.branch.finalDelayDays || 0, i.branch.delayReason || '' ]) ]; let csvContent = "data:text/csv;charset=utf-8,\uFEFF" + rows.map(e => e.join(",")).join("\n"); const encodedUri = encodeURI(csvContent); const link = document.createElement("a"); link.setAttribute("href", encodedUri); link.setAttribute("download", `mkgt_history_report.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link); },
                toggleExpand(p) { p.expanded = !p.expanded; },
                calcSubProjectHours(sp) { return (sp.events || []).reduce((sum, ev) => sum + Number(ev.hours || 0), 0); },
                getMilestoneName(mid) { return this.currentSubProject?.milestones?.find(m => m.id === mid)?.title || 'Unknown'; },
                isMilestoneOverdue(ms) { if (ms.isCompleted) return false; if(!ms.date) return false; return new Date(ms.date) < new Date().setHours(0,0,0,0); },
                getDaysLate(d) { if(!d) return 0; return Math.ceil((new Date() - new Date(d)) / (1000 * 60 * 60 * 24)); },
                getDaysHeld(d) { if(!d) return 0; const today = new Date(); today.setHours(0,0,0,0); const handoff = new Date(d); handoff.setHours(0,0,0,0); return Math.floor((today - handoff) / (1000 * 60 * 60 * 24)); },
                getSubProjectDelayDays(sp) { 
                    if(sp.status === 'completed') return sp.finalDelayDays || 0; 
                    if (!sp.endDate) return 0; 
                    const today = new Date(); today.setHours(0,0,0,0); 
                    const target = new Date(sp.endDate); target.setHours(0,0,0,0); 
                    if (target < today && sp.status !== 'aborted') return Math.floor((today - target) / 86400000); 
                    return 0; 
                },
                getProjectHealth(sp) {
                    if (sp.status === 'completed') {
                        if (sp.finalDelayDays > 0) return { type: 'delay', days: sp.finalDelayDays };
                        return { type: 'normal', days: 0 };
                    }
                    if (sp.status === 'aborted') return { type: 'aborted', days: 0 };
                    const today = new Date(); today.setHours(0,0,0,0);
                    if (!sp.endDate) return { type: 'normal', days: 0 };
                    const deadline = new Date(sp.endDate); deadline.setHours(0,0,0,0);
                    if (deadline < today) {
                        return { type: 'delay', days: Math.floor((today - deadline) / 86400000) };
                    }
                    if (sp.milestones && sp.milestones.length > 0) {
                        const sorted = [...sp.milestones].sort((a,b) => new Date(a.date) - new Date(b.date));
                        const uncompleted = sorted.filter(m => !m.isCompleted);
                        if (uncompleted.length > 0) {
                            const nextMs = uncompleted[0];
                            if (nextMs.id !== sorted[sorted.length-1].id) {
                                const msDate = new Date(nextMs.date); msDate.setHours(0,0,0,0);
                                if (msDate < today) {
                                    return { type: 'lag', days: Math.floor((today - msDate) / 86400000) };
                                }
                            }
                        }
                    }
                    return { type: 'normal', days: Math.floor((deadline - today) / 86400000) };
                },
                statusBadge(s) { if(s==='completed') return 'bg-emerald-100 text-emerald-700'; if(s==='in_progress') return 'bg-indigo-100 text-indigo-700'; if(s==='aborted') return 'bg-slate-200 text-slate-600'; return 'bg-yellow-100 text-yellow-700'; },
                getDeadlineStatus(dateStr) { if (!dateStr) return { status: 'normal', label: 'æœªå®š', days: 0 }; const today = new Date(); today.setHours(0,0,0,0); const target = new Date(dateStr); target.setHours(0,0,0,0); const diffTime = target - today; const diffDays = Math.floor(diffTime / 86400000); if (diffDays < 0) return { status: 'overdue', label: `å»¶é² ${Math.abs(diffDays)} å¤©`, days: Math.abs(diffDays) }; if (diffDays <= 7) return { status: 'warning', label: `å‰© ${diffDays} å¤©`, days: diffDays }; return { status: 'normal', label: `å‰© ${diffDays} å¤©`, days: diffDays }; },
                getDateStyle(dateStr) { const s = this.getDeadlineStatus(dateStr); if(s.status === 'overdue') return 'text-red-600 font-bold'; if(s.status === 'warning') return 'text-yellow-600 font-bold'; return 'text-slate-500'; },
                getBranchProgress(branch) { const total = branch.milestones?.length || 0; if (total === 0) return { percent: 0 }; const done = branch.milestones.filter(m => m.isCompleted).length; return { percent: Math.round((done / total) * 100) }; },
                branchHasDelay(branch) { return this.getSubProjectDelayDays(branch) > 0; }
            }
        }).mount('#app');
    </script>

</body>
</html>